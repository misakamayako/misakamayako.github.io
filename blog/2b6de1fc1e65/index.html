<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="-RgOsAO7rMTpJ8vNk8-ILdAA8VmiTEUc9HiUVVTKeEs"><meta name="generator" content="Astro v5.13.5"><title>✨御坂网络-基于Kotlin协程的高效异步文件上传服务设计与实现✨</title><link rel="stylesheet" href="/_astro/index.CVE_tfyK.css">
<style>/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid}}}.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%;position:relative}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88047 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% -.0000298023 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid;--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0}}}.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s));transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.BkXjpIp6.css"><script type="module" src="/_astro/page.V2R8AmkL.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/" class="q0UmqG_navLink">home</a> <a href="/blog/" class="q0UmqG_navLink">blog</a> <a href="/utils/" class="q0UmqG_navLink">utils</a> <a href="/dream-map/" class="inline-block">dream map</a> <a href="/album/" class="q0UmqG_navLink">album</a> <a href="/about-me/" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px]"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">作者：misakamayako</p>  <p class="text-white text-center mt-2">发布时间：2024/07/03</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">简介</h3> <p class="text-white font-light mb-2">本文介绍如何使用Kotlin协程设计一个高效、可靠的异步文件上传服务，解决背压带来的资源瓶颈问题，并详细讲解协程管理、任务状态追踪、安全关闭等关键实现。</p> </div> <!-- 2. 文章目录 --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">本文目录</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. 随机文章 --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">随便看看</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/15b29448545c/"> Web Worker 类型概览 </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/7631b3f6f737/"> axios在node环境中使用时不能正确访问本地服务的问题 </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/62d9809bf8c2/"> Jetpack Compose 中使用 Server-Sent Events（SSE） </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-zinc-200 mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-current prose-strong:text-current prose-code:text-current
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>基于Kotlin协程的高效异步文件上传服务设计与实现</h1> </header> <h2 id="背景">背景</h2>
<p>在传统服务中，当服务器接收到文件上传任务时，会直接在当前线程或新开线程中执行任务，但是如果背压过高，有可能由于服务器带宽和oss上传限制等原因导致每个进程被分配的资源过少导致任务时间过长。<br>
本文将介绍如何使用Kotlin协程实现一个高效、可靠的文件上传服务</p>
<blockquote>
<p>背压是指消费速度跟不上产生数据的速度，从而造成数据积压和资源耗尽</p>
</blockquote>
<h2 id="解决思路">解决思路</h2>
<p>核心思路是构建一个可扩展的异步服务，该服务能统一处理系统中的任务，并且能够安全地启动和关闭。</p>
<h3 id="1-基于协程的异步服务构建">1. 基于协程的异步服务构建</h3>
<p>考虑到上传任务主要消耗在I/O网络操作上，而且OSSClient是线程安全的，因此将上传服务设计为单例模式，并在单一协程中处理任务，以优化资源利用。</p>
<h3 id="2-协程coroutine管理">2. 协程(Coroutine)管理</h3>
<p>服务作为单例运行，需对协程生命周期进行管理，确保任务处理的安全性。因此使用<code>Dispatchers.IO</code>+<code>Job</code>的组合，控制它的执行和生命周期。</p>
<h3 id="3-任务处理">3. 任务处理</h3>
<p>当新任务被创建时，会创建一个<code>CompletableDeferred&#x3C;~></code>对象，用于保存任务执行结构和告知外部任务状态，然后将任务提交到<code>Channel</code>中，等待资源空闲之后执行任务。</p>
<h3 id="4-安全关闭资源">4. 安全关闭资源</h3>
<p>当服务将关闭时，我们期望以提交的任务都能完成并且资源能够被正确释放。因此我们需要手动的处理关闭部分。</p>
<h2 id="下面先看一个完整的代码示例">下面先看一个完整的代码示例</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#B392F0">@Service</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> OSSService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> logger: </span><span style="color:#B392F0">Logger</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> LoggerFactory.</span><span style="color:#B392F0">getLogger</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 应用配置，用于获取AccessKey等敏感信息</span></span>
<span class="line"><span style="color:#B392F0">   @Autowired</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> lateinit</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> applicationConfig: </span><span style="color:#B392F0">ApplicationConfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // AES加解密服务，用于处理敏感信息</span></span>
<span class="line"><span style="color:#B392F0">   @Autowired</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> lateinit</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> aesEncrypto: </span><span style="color:#B392F0">AesEncrypto</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // OSS客户端实例</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> lateinit</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> ossClient: </span><span style="color:#B392F0">OSS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 协程作业和作用域</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> job </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Job</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> scope </span><span style="color:#F97583">=</span><span style="color:#B392F0"> CoroutineScope</span><span style="color:#E1E4E8">(Dispatchers.IO </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> job)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 初始化OSS客户端</span></span>
<span class="line"><span style="color:#B392F0">   @PostConstruct</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> initOSS</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> accessKeyId </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> aesEncrypto.</span><span style="color:#B392F0">decrypt</span><span style="color:#E1E4E8">(applicationConfig.accessKeyId)</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> accessKeySecret </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> aesEncrypto.</span><span style="color:#B392F0">decrypt</span><span style="color:#E1E4E8">(applicationConfig.accessKeySecret)</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> endpoint </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> applicationConfig.endpoint</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> config </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ClientBuilderConfiguration</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">         protocol </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Protocol.HTTPS</span></span>
<span class="line"><span style="color:#E1E4E8">         userAgent </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "aliyun-sdk-kotlin"</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">      ossClient </span><span style="color:#F97583">=</span><span style="color:#B392F0"> OSSClientBuilder</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"https://</span><span style="color:#79B8FF">$endpoint</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, accessKeyId, accessKeySecret, config)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // 启动处理请求的协程</span></span>
<span class="line"><span style="color:#E1E4E8">      scope.</span><span style="color:#B392F0">launch</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">         processRequests</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 创建一个有25大小缓冲区的Channel</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> requestChannel </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Channel</span><span style="color:#F97583">&#x3C;suspend</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> Unit</span><span style="color:#F97583">></span><span style="color:#E1E4E8">(capacity </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 25</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 提交上传任务到Channel中</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> submit</span><span style="color:#E1E4E8">(request: </span><span style="color:#B392F0">suspend</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> Unit) {</span></span>
<span class="line"><span style="color:#E1E4E8">      requestChannel.</span><span style="color:#B392F0">send</span><span style="color:#E1E4E8">(request)</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 处理上传请求</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> processRequests</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8"> (request </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> requestChannel) {</span></span>
<span class="line"><span style="color:#F97583">         try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            // oss内部有超时报错机制，这里不需要再加 withTimeout 了</span></span>
<span class="line"><span style="color:#B392F0">            request</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e: </span><span style="color:#B392F0">Exception</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            logger.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(e.message)</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 服务关闭时的资源释放</span></span>
<span class="line"><span style="color:#B392F0">   @PreDestroy</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> closeGracefully</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">      runBlocking</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">         logger.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Shutting down OSSService, waiting for pending tasks to complete."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">         requestChannel.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         job.</span><span style="color:#B392F0">cancelAndJoin</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         ossClient.</span><span style="color:#B392F0">shutdown</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         logger.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"OSSService shutdown complete."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // 上传对象方法，其它的方法请自行实现</span></span>
<span class="line"><span style="color:#F97583">   suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> putObject</span><span style="color:#E1E4E8">(bucketName: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, key: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, input: </span><span style="color:#B392F0">InputStream</span><span style="color:#E1E4E8">): </span><span style="color:#B392F0">Deferred</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PutObjectResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">      logger.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Putting object: </span><span style="color:#79B8FF">$bucketName</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">$key</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> result </span><span style="color:#F97583">=</span><span style="color:#B392F0"> CompletableDeferred</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PutObjectResult</span><span style="color:#E1E4E8">>()</span></span>
<span class="line"><span style="color:#B392F0">      submit</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">         try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            val</span><span style="color:#E1E4E8"> putResult </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ossClient.</span><span style="color:#B392F0">putObject</span><span style="color:#E1E4E8">(bucketName, key, input)</span></span>
<span class="line"><span style="color:#E1E4E8">            result.</span><span style="color:#B392F0">complete</span><span style="color:#E1E4E8">(putResult)</span></span>
<span class="line"><span style="color:#E1E4E8">         } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e: </span><span style="color:#B392F0">Exception</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            result.</span><span style="color:#B392F0">completeExceptionally</span><span style="color:#E1E4E8">(e)</span></span>
<span class="line"><span style="color:#E1E4E8">            logger.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(e.message)</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="关键点分析">关键点分析</h2>
<h3 id="1-任务处理机制">1. 任务处理机制</h3>
<ul>
<li>CompletableDeferred：每当有新任务时，创建CompletableDeferred对象来存储执行结果，允许外部监控任务状态。</li>
<li>Channel机制：任务通过Channel提交，这是一个具有有限缓冲区的通道，用于传递任务执行单元，防止背压问题。</li>
</ul>
<h3 id="2-资源安全关闭">2. 资源安全关闭：</h3>
<ul>
<li>任务都是基于协程创建，所以使用<code>runBlocking</code>阻塞当前线程直到操作完成</li>
<li>首先关闭了<code>requestChannel</code>，这是一个存放待处理上传请求的通道。关闭通道后，不会再接受新的请求，但已发送到通道中的请求将继续被处理。</li>
<li>取消<code>job</code>，这是与<code>CoroutineScope</code>关联的<code>Job</code>实例。<code>cancel</code>会尝试取消所有在这个<code>Job</code>下运行的协程，而<code>join</code>则会阻塞当前线程，直到所有协程完成。这一步确保了所有上传任务被完成或适当地取消。</li>
<li>最后关闭OSS客户端，释放了所有与OSS客户端相关的资源，比如网络连接和线程池等。</li>
</ul>
<h3 id="3-任务状态跟踪">3. 任务状态跟踪：</h3>
<ul>
<li>任务状态的跟踪主要通过<code>CompletableDeferred</code>对象来实现。<code>CompletableDeferred</code>是Kotlin协程库中用于表示异步计算结果的类型，它可以被用来构建异步工作流，支持异步任务的启动、暂停和完成。</li>
<li>当一个新任务被创建时，代码中会创建一个<code>CompletableDeferred</code>实例，这个实例用于保存任务的执行结果以及告知外部任务的状态。<code>CompletableDeferred</code>对象会在任务成功完成时通过<code>complete</code>方法来设置结果，如果任务执行过程中遇到异常，则通过<code>completeExceptionally</code>方法来记录异常。</li>
</ul>
<h3 id="4-选择使用channel而不是blockingqueue">4. 选择使用Channel而不是BlockingQueue</h3>
<ul>
<li>更好的协程支持：Channel是Kotlin协程库的一部分，专为协程设计，能够无缝集成协程的挂起和恢复机制。
使用Channel可以避免将阻塞操作引入协程代码中，从而保持协程的非阻塞特性。</li>
<li>简化的API：Channel提供了一组简洁而强大的API，可以轻松实现不同类型的通道，如BufferedChannel、RendezvousChannel等。
Channel的API设计与协程的其他部分一致，使得代码更具一致性和可读性。</li>
<li>更好的性能：Channel在设计上针对协程的并发模型进行了优化，通常在协程的高并发场景下表现更好。
Channel通过非阻塞的方式实现生产者-消费者模式，减少了上下文切换和线程切换的开销。</li>
<li>灵活性：Channel支持多种类型的通道，如无缓冲通道、缓冲通道、单元素通道等，可以根据需求选择合适的通道类型。
Channel还支持各种关闭和取消操作，使得资源管理和清理变得更加灵活和方便。</li>
<li>扩展性：由于Channel是Kotlin协程库的一部分，能够与其他协程特性和库（如Flow、CoroutineScope等）无缝集成，提供更多的扩展性和功能。</li>
</ul>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin/">Kotlin</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/协程/">协程</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/文件上传/">文件上传</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/OSS/">OSS</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/异步编程/">异步编程</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/后端设计/">后端设计</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">📫</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="知识共享许可协议" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div> <script type="module" is:global>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach((block) => {
                const button = document.createElement('button')
                button.innerText = '复制'
                button.className =
                    'absolute top-2 right-2 bg-slate-800 text-white px-2 py-1 rounded text-sm opacity-50 hover:opacity-100 transition cursor-pointer'
                button.addEventListener('click', () => {
                    const code = block.querySelector('code')
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerText = '已复制！'
                            setTimeout(() => (button.innerText = '复制'), 1000)
                        })
                    }
                })
                block.classList.add('relative')
                block.appendChild(button)
            })
        })
    </script>  </body></html>