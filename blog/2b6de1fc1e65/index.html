<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="-RgOsAO7rMTpJ8vNk8-ILdAA8VmiTEUc9HiUVVTKeEs"><meta name="generator" content="Astro v5.16.6"><title>âœ¨å¾¡å‚ç½‘ç»œ-åŸºäºKotlinåç¨‹çš„é«˜æ•ˆå¼‚æ­¥æ–‡ä»¶ä¸Šä¼ æœåŠ¡è®¾è®¡ä¸å®ç°âœ¨</title><link rel="stylesheet" href="/_astro/index.BT8t14_1.css">
<style>/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid}}}.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%;position:relative}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88047 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% -.0000298023 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid;--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0}}}.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.BOOrbLic.css"><script type="module" src="/_astro/page.D1uwR3nK.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/" class="q0UmqG_navLink">home</a> <a href="/blog/" class="q0UmqG_navLink">blog</a> <a href="/utils/" class="q0UmqG_navLink">utils</a> <a href="/dream-map/" class="inline-block">dream map</a> <a href="/album/" class="q0UmqG_navLink">album</a> <a href="/about-me/" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px] overflow-auto"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">ä½œè€…ï¼šmisakamayako</p>  <p class="text-white text-center mt-2">å‘å¸ƒæ—¶é—´ï¼š2024/07/03</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">ç®€ä»‹</h3> <p class="text-white font-light mb-2">æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨Kotlinåç¨‹è®¾è®¡ä¸€ä¸ªé«˜æ•ˆã€å¯é çš„å¼‚æ­¥æ–‡ä»¶ä¸Šä¼ æœåŠ¡ï¼Œè§£å†³èƒŒå‹å¸¦æ¥çš„èµ„æºç“¶é¢ˆé—®é¢˜ï¼Œå¹¶è¯¦ç»†è®²è§£åç¨‹ç®¡ç†ã€ä»»åŠ¡çŠ¶æ€è¿½è¸ªã€å®‰å…¨å…³é—­ç­‰å…³é”®å®ç°ã€‚</p> </div> <!-- 2. æ–‡ç« ç›®å½• --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">æœ¬æ–‡ç›®å½•</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. éšæœºæ–‡ç«  --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">éšä¾¿çœ‹çœ‹</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/2ed8a0ceb014/"> WebGPU vs CPUï¼šå¹¶è¡Œè®¡ç®—æ€§èƒ½å®æµ‹å¯¹æ¯” </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/7631b3f6f737/"> axiosåœ¨nodeç¯å¢ƒä¸­ä½¿ç”¨æ—¶ä¸èƒ½æ­£ç¡®è®¿é—®æœ¬åœ°æœåŠ¡çš„é—®é¢˜ </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/31aca58e217e/"> Javaæ€§èƒ½è°ƒä¼˜ï¼šä¸ºä½•VarHandleæ˜¯å–ä»£åå°„çš„â€œé“¶å¼¹â€ï¼Ÿ </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-zinc-200 mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-current prose-strong:text-current prose-code:text-current
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>åŸºäºKotlinåç¨‹çš„é«˜æ•ˆå¼‚æ­¥æ–‡ä»¶ä¸Šä¼ æœåŠ¡è®¾è®¡ä¸å®ç°</h1> </header> <h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>åœ¨ä¼ ç»ŸæœåŠ¡ä¸­ï¼Œå½“æœåŠ¡å™¨æ¥æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ ä»»åŠ¡æ—¶ï¼Œä¼šç›´æ¥åœ¨å½“å‰çº¿ç¨‹æˆ–æ–°å¼€çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯å¦‚æœèƒŒå‹è¿‡é«˜ï¼Œæœ‰å¯èƒ½ç”±äºæœåŠ¡å™¨å¸¦å®½å’Œossä¸Šä¼ é™åˆ¶ç­‰åŸå› å¯¼è‡´æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…çš„èµ„æºè¿‡å°‘å¯¼è‡´ä»»åŠ¡æ—¶é—´è¿‡é•¿ã€‚<br>
æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Kotlinåç¨‹å®ç°ä¸€ä¸ªé«˜æ•ˆã€å¯é çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡</p>
<blockquote>
<p>èƒŒå‹æ˜¯æŒ‡æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šäº§ç”Ÿæ•°æ®çš„é€Ÿåº¦ï¼Œä»è€Œé€ æˆæ•°æ®ç§¯å‹å’Œèµ„æºè€—å°½</p>
</blockquote>
<h2 id="è§£å†³æ€è·¯">è§£å†³æ€è·¯</h2>
<p>æ ¸å¿ƒæ€è·¯æ˜¯æ„å»ºä¸€ä¸ªå¯æ‰©å±•çš„å¼‚æ­¥æœåŠ¡ï¼Œè¯¥æœåŠ¡èƒ½ç»Ÿä¸€å¤„ç†ç³»ç»Ÿä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”èƒ½å¤Ÿå®‰å…¨åœ°å¯åŠ¨å’Œå…³é—­ã€‚</p>
<h3 id="1-åŸºäºåç¨‹çš„å¼‚æ­¥æœåŠ¡æ„å»º">1. åŸºäºåç¨‹çš„å¼‚æ­¥æœåŠ¡æ„å»º</h3>
<p>è€ƒè™‘åˆ°ä¸Šä¼ ä»»åŠ¡ä¸»è¦æ¶ˆè€—åœ¨I/Oç½‘ç»œæ“ä½œä¸Šï¼Œè€Œä¸”OSSClientæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤å°†ä¸Šä¼ æœåŠ¡è®¾è®¡ä¸ºå•ä¾‹æ¨¡å¼ï¼Œå¹¶åœ¨å•ä¸€åç¨‹ä¸­å¤„ç†ä»»åŠ¡ï¼Œä»¥ä¼˜åŒ–èµ„æºåˆ©ç”¨ã€‚</p>
<h3 id="2-åç¨‹coroutineç®¡ç†">2. åç¨‹(Coroutine)ç®¡ç†</h3>
<p>æœåŠ¡ä½œä¸ºå•ä¾‹è¿è¡Œï¼Œéœ€å¯¹åç¨‹ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ï¼Œç¡®ä¿ä»»åŠ¡å¤„ç†çš„å®‰å…¨æ€§ã€‚å› æ­¤ä½¿ç”¨<code>Dispatchers.IO</code>+<code>Job</code>çš„ç»„åˆï¼Œæ§åˆ¶å®ƒçš„æ‰§è¡Œå’Œç”Ÿå‘½å‘¨æœŸã€‚</p>
<h3 id="3-ä»»åŠ¡å¤„ç†">3. ä»»åŠ¡å¤„ç†</h3>
<p>å½“æ–°ä»»åŠ¡è¢«åˆ›å»ºæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª<code>CompletableDeferred&#x3C;~></code>å¯¹è±¡ï¼Œç”¨äºä¿å­˜ä»»åŠ¡æ‰§è¡Œç»“æ„å’Œå‘ŠçŸ¥å¤–éƒ¨ä»»åŠ¡çŠ¶æ€ï¼Œç„¶åå°†ä»»åŠ¡æäº¤åˆ°<code>Channel</code>ä¸­ï¼Œç­‰å¾…èµ„æºç©ºé—²ä¹‹åæ‰§è¡Œä»»åŠ¡ã€‚</p>
<h3 id="4-å®‰å…¨å…³é—­èµ„æº">4. å®‰å…¨å…³é—­èµ„æº</h3>
<p>å½“æœåŠ¡å°†å…³é—­æ—¶ï¼Œæˆ‘ä»¬æœŸæœ›ä»¥æäº¤çš„ä»»åŠ¡éƒ½èƒ½å®Œæˆå¹¶ä¸”èµ„æºèƒ½å¤Ÿè¢«æ­£ç¡®é‡Šæ”¾ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨çš„å¤„ç†å…³é—­éƒ¨åˆ†ã€‚</p>
<h2 id="ä¸‹é¢å…ˆçœ‹ä¸€ä¸ªå®Œæ•´çš„ä»£ç ç¤ºä¾‹">ä¸‹é¢å…ˆçœ‹ä¸€ä¸ªå®Œæ•´çš„ä»£ç ç¤ºä¾‹</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#B392F0">@Service</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> OSSService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> logger: </span><span style="color:#B392F0">Logger</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> LoggerFactory.</span><span style="color:#B392F0">getLogger</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // åº”ç”¨é…ç½®ï¼Œç”¨äºè·å–AccessKeyç­‰æ•æ„Ÿä¿¡æ¯</span></span>
<span class="line"><span style="color:#B392F0">   @Autowired</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> lateinit</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> applicationConfig: </span><span style="color:#B392F0">ApplicationConfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // AESåŠ è§£å¯†æœåŠ¡ï¼Œç”¨äºå¤„ç†æ•æ„Ÿä¿¡æ¯</span></span>
<span class="line"><span style="color:#B392F0">   @Autowired</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> lateinit</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> aesEncrypto: </span><span style="color:#B392F0">AesEncrypto</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // OSSå®¢æˆ·ç«¯å®ä¾‹</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> lateinit</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> ossClient: </span><span style="color:#B392F0">OSS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // åç¨‹ä½œä¸šå’Œä½œç”¨åŸŸ</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> job </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Job</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> scope </span><span style="color:#F97583">=</span><span style="color:#B392F0"> CoroutineScope</span><span style="color:#E1E4E8">(Dispatchers.IO </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> job)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // åˆå§‹åŒ–OSSå®¢æˆ·ç«¯</span></span>
<span class="line"><span style="color:#B392F0">   @PostConstruct</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> initOSS</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> accessKeyId </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> aesEncrypto.</span><span style="color:#B392F0">decrypt</span><span style="color:#E1E4E8">(applicationConfig.accessKeyId)</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> accessKeySecret </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> aesEncrypto.</span><span style="color:#B392F0">decrypt</span><span style="color:#E1E4E8">(applicationConfig.accessKeySecret)</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> endpoint </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> applicationConfig.endpoint</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> config </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ClientBuilderConfiguration</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">         protocol </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Protocol.HTTPS</span></span>
<span class="line"><span style="color:#E1E4E8">         userAgent </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "aliyun-sdk-kotlin"</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">      ossClient </span><span style="color:#F97583">=</span><span style="color:#B392F0"> OSSClientBuilder</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"https://</span><span style="color:#79B8FF">$endpoint</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, accessKeyId, accessKeySecret, config)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // å¯åŠ¨å¤„ç†è¯·æ±‚çš„åç¨‹</span></span>
<span class="line"><span style="color:#E1E4E8">      scope.</span><span style="color:#B392F0">launch</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">         processRequests</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // åˆ›å»ºä¸€ä¸ªæœ‰25å¤§å°ç¼“å†²åŒºçš„Channel</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> requestChannel </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Channel</span><span style="color:#F97583">&#x3C;suspend</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> Unit</span><span style="color:#F97583">></span><span style="color:#E1E4E8">(capacity </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 25</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // æäº¤ä¸Šä¼ ä»»åŠ¡åˆ°Channelä¸­</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> submit</span><span style="color:#E1E4E8">(request: </span><span style="color:#B392F0">suspend</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> Unit) {</span></span>
<span class="line"><span style="color:#E1E4E8">      requestChannel.</span><span style="color:#B392F0">send</span><span style="color:#E1E4E8">(request)</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // å¤„ç†ä¸Šä¼ è¯·æ±‚</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> processRequests</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8"> (request </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> requestChannel) {</span></span>
<span class="line"><span style="color:#F97583">         try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            // osså†…éƒ¨æœ‰è¶…æ—¶æŠ¥é”™æœºåˆ¶ï¼Œè¿™é‡Œä¸éœ€è¦å†åŠ  withTimeout äº†</span></span>
<span class="line"><span style="color:#B392F0">            request</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e: </span><span style="color:#B392F0">Exception</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            logger.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(e.message)</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // æœåŠ¡å…³é—­æ—¶çš„èµ„æºé‡Šæ”¾</span></span>
<span class="line"><span style="color:#B392F0">   @PreDestroy</span></span>
<span class="line"><span style="color:#F97583">   private</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> closeGracefully</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">      runBlocking</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">         logger.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Shutting down OSSService, waiting for pending tasks to complete."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">         requestChannel.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         job.</span><span style="color:#B392F0">cancelAndJoin</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         ossClient.</span><span style="color:#B392F0">shutdown</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         logger.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"OSSService shutdown complete."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // ä¸Šä¼ å¯¹è±¡æ–¹æ³•ï¼Œå…¶å®ƒçš„æ–¹æ³•è¯·è‡ªè¡Œå®ç°</span></span>
<span class="line"><span style="color:#F97583">   suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> putObject</span><span style="color:#E1E4E8">(bucketName: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, key: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, input: </span><span style="color:#B392F0">InputStream</span><span style="color:#E1E4E8">): </span><span style="color:#B392F0">Deferred</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PutObjectResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">      logger.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Putting object: </span><span style="color:#79B8FF">$bucketName</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">$key</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">      val</span><span style="color:#E1E4E8"> result </span><span style="color:#F97583">=</span><span style="color:#B392F0"> CompletableDeferred</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PutObjectResult</span><span style="color:#E1E4E8">>()</span></span>
<span class="line"><span style="color:#B392F0">      submit</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">         try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            val</span><span style="color:#E1E4E8"> putResult </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ossClient.</span><span style="color:#B392F0">putObject</span><span style="color:#E1E4E8">(bucketName, key, input)</span></span>
<span class="line"><span style="color:#E1E4E8">            result.</span><span style="color:#B392F0">complete</span><span style="color:#E1E4E8">(putResult)</span></span>
<span class="line"><span style="color:#E1E4E8">         } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e: </span><span style="color:#B392F0">Exception</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            result.</span><span style="color:#B392F0">completeExceptionally</span><span style="color:#E1E4E8">(e)</span></span>
<span class="line"><span style="color:#E1E4E8">            logger.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(e.message)</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> result</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="å…³é”®ç‚¹åˆ†æ">å…³é”®ç‚¹åˆ†æ</h2>
<h3 id="1-ä»»åŠ¡å¤„ç†æœºåˆ¶">1. ä»»åŠ¡å¤„ç†æœºåˆ¶</h3>
<ul>
<li>CompletableDeferredï¼šæ¯å½“æœ‰æ–°ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºCompletableDeferredå¯¹è±¡æ¥å­˜å‚¨æ‰§è¡Œç»“æœï¼Œå…è®¸å¤–éƒ¨ç›‘æ§ä»»åŠ¡çŠ¶æ€ã€‚</li>
<li>Channelæœºåˆ¶ï¼šä»»åŠ¡é€šè¿‡Channelæäº¤ï¼Œè¿™æ˜¯ä¸€ä¸ªå…·æœ‰æœ‰é™ç¼“å†²åŒºçš„é€šé“ï¼Œç”¨äºä¼ é€’ä»»åŠ¡æ‰§è¡Œå•å…ƒï¼Œé˜²æ­¢èƒŒå‹é—®é¢˜ã€‚</li>
</ul>
<h3 id="2-èµ„æºå®‰å…¨å…³é—­">2. èµ„æºå®‰å…¨å…³é—­ï¼š</h3>
<ul>
<li>ä»»åŠ¡éƒ½æ˜¯åŸºäºåç¨‹åˆ›å»ºï¼Œæ‰€ä»¥ä½¿ç”¨<code>runBlocking</code>é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æ“ä½œå®Œæˆ</li>
<li>é¦–å…ˆå…³é—­äº†<code>requestChannel</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå­˜æ”¾å¾…å¤„ç†ä¸Šä¼ è¯·æ±‚çš„é€šé“ã€‚å…³é—­é€šé“åï¼Œä¸ä¼šå†æ¥å—æ–°çš„è¯·æ±‚ï¼Œä½†å·²å‘é€åˆ°é€šé“ä¸­çš„è¯·æ±‚å°†ç»§ç»­è¢«å¤„ç†ã€‚</li>
<li>å–æ¶ˆ<code>job</code>ï¼Œè¿™æ˜¯ä¸<code>CoroutineScope</code>å…³è”çš„<code>Job</code>å®ä¾‹ã€‚<code>cancel</code>ä¼šå°è¯•å–æ¶ˆæ‰€æœ‰åœ¨è¿™ä¸ª<code>Job</code>ä¸‹è¿è¡Œçš„åç¨‹ï¼Œè€Œ<code>join</code>åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰åç¨‹å®Œæˆã€‚è¿™ä¸€æ­¥ç¡®ä¿äº†æ‰€æœ‰ä¸Šä¼ ä»»åŠ¡è¢«å®Œæˆæˆ–é€‚å½“åœ°å–æ¶ˆã€‚</li>
<li>æœ€åå…³é—­OSSå®¢æˆ·ç«¯ï¼Œé‡Šæ”¾äº†æ‰€æœ‰ä¸OSSå®¢æˆ·ç«¯ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚ç½‘ç»œè¿æ¥å’Œçº¿ç¨‹æ± ç­‰ã€‚</li>
</ul>
<h3 id="3-ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª">3. ä»»åŠ¡çŠ¶æ€è·Ÿè¸ªï¼š</h3>
<ul>
<li>ä»»åŠ¡çŠ¶æ€çš„è·Ÿè¸ªä¸»è¦é€šè¿‡<code>CompletableDeferred</code>å¯¹è±¡æ¥å®ç°ã€‚<code>CompletableDeferred</code>æ˜¯Kotlinåç¨‹åº“ä¸­ç”¨äºè¡¨ç¤ºå¼‚æ­¥è®¡ç®—ç»“æœçš„ç±»å‹ï¼Œå®ƒå¯ä»¥è¢«ç”¨æ¥æ„å»ºå¼‚æ­¥å·¥ä½œæµï¼Œæ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„å¯åŠ¨ã€æš‚åœå’Œå®Œæˆã€‚</li>
<li>å½“ä¸€ä¸ªæ–°ä»»åŠ¡è¢«åˆ›å»ºæ—¶ï¼Œä»£ç ä¸­ä¼šåˆ›å»ºä¸€ä¸ª<code>CompletableDeferred</code>å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹ç”¨äºä¿å­˜ä»»åŠ¡çš„æ‰§è¡Œç»“æœä»¥åŠå‘ŠçŸ¥å¤–éƒ¨ä»»åŠ¡çš„çŠ¶æ€ã€‚<code>CompletableDeferred</code>å¯¹è±¡ä¼šåœ¨ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶é€šè¿‡<code>complete</code>æ–¹æ³•æ¥è®¾ç½®ç»“æœï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ï¼Œåˆ™é€šè¿‡<code>completeExceptionally</code>æ–¹æ³•æ¥è®°å½•å¼‚å¸¸ã€‚</li>
</ul>
<h3 id="4-é€‰æ‹©ä½¿ç”¨channelè€Œä¸æ˜¯blockingqueue">4. é€‰æ‹©ä½¿ç”¨Channelè€Œä¸æ˜¯BlockingQueue</h3>
<ul>
<li>æ›´å¥½çš„åç¨‹æ”¯æŒï¼šChannelæ˜¯Kotlinåç¨‹åº“çš„ä¸€éƒ¨åˆ†ï¼Œä¸“ä¸ºåç¨‹è®¾è®¡ï¼Œèƒ½å¤Ÿæ— ç¼é›†æˆåç¨‹çš„æŒ‚èµ·å’Œæ¢å¤æœºåˆ¶ã€‚
ä½¿ç”¨Channelå¯ä»¥é¿å…å°†é˜»å¡æ“ä½œå¼•å…¥åç¨‹ä»£ç ä¸­ï¼Œä»è€Œä¿æŒåç¨‹çš„éé˜»å¡ç‰¹æ€§ã€‚</li>
<li>ç®€åŒ–çš„APIï¼šChannelæä¾›äº†ä¸€ç»„ç®€æ´è€Œå¼ºå¤§çš„APIï¼Œå¯ä»¥è½»æ¾å®ç°ä¸åŒç±»å‹çš„é€šé“ï¼Œå¦‚BufferedChannelã€RendezvousChannelç­‰ã€‚
Channelçš„APIè®¾è®¡ä¸åç¨‹çš„å…¶ä»–éƒ¨åˆ†ä¸€è‡´ï¼Œä½¿å¾—ä»£ç æ›´å…·ä¸€è‡´æ€§å’Œå¯è¯»æ€§ã€‚</li>
<li>æ›´å¥½çš„æ€§èƒ½ï¼šChannelåœ¨è®¾è®¡ä¸Šé’ˆå¯¹åç¨‹çš„å¹¶å‘æ¨¡å‹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé€šå¸¸åœ¨åç¨‹çš„é«˜å¹¶å‘åœºæ™¯ä¸‹è¡¨ç°æ›´å¥½ã€‚
Channelé€šè¿‡éé˜»å¡çš„æ–¹å¼å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚</li>
<li>çµæ´»æ€§ï¼šChannelæ”¯æŒå¤šç§ç±»å‹çš„é€šé“ï¼Œå¦‚æ— ç¼“å†²é€šé“ã€ç¼“å†²é€šé“ã€å•å…ƒç´ é€šé“ç­‰ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„é€šé“ç±»å‹ã€‚
Channelè¿˜æ”¯æŒå„ç§å…³é—­å’Œå–æ¶ˆæ“ä½œï¼Œä½¿å¾—èµ„æºç®¡ç†å’Œæ¸…ç†å˜å¾—æ›´åŠ çµæ´»å’Œæ–¹ä¾¿ã€‚</li>
<li>æ‰©å±•æ€§ï¼šç”±äºChannelæ˜¯Kotlinåç¨‹åº“çš„ä¸€éƒ¨åˆ†ï¼Œèƒ½å¤Ÿä¸å…¶ä»–åç¨‹ç‰¹æ€§å’Œåº“ï¼ˆå¦‚Flowã€CoroutineScopeç­‰ï¼‰æ— ç¼é›†æˆï¼Œæä¾›æ›´å¤šçš„æ‰©å±•æ€§å’ŒåŠŸèƒ½ã€‚</li>
</ul>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin/">Kotlin</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin åç¨‹/">Kotlin åç¨‹</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/æ–‡ä»¶ä¸Šä¼ /">æ–‡ä»¶ä¸Šä¼ </a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/OSS/">OSS</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/å¼‚æ­¥ç¼–ç¨‹/">å¼‚æ­¥ç¼–ç¨‹</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/åç«¯è®¾è®¡/">åç«¯è®¾è®¡</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">ğŸ“«</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div> <script type="module" is:global>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach((block) => {
                const button = document.createElement('button')
                button.innerText = 'å¤åˆ¶'
                button.className =
                    'absolute top-2 right-2 bg-slate-800 text-white px-2 py-1 rounded text-sm opacity-50 hover:opacity-100 transition cursor-pointer'
                button.addEventListener('click', () => {
                    const code = block.querySelector('code')
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerText = 'å·²å¤åˆ¶ï¼'
                            setTimeout(() => (button.innerText = 'å¤åˆ¶'), 1000)
                        })
                    }
                })
                block.classList.add('relative')
                block.appendChild(button)
            })
        })
    </script>  </body></html>