<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="-RgOsAO7rMTpJ8vNk8-ILdAA8VmiTEUc9HiUVVTKeEs"><meta name="generator" content="Astro v5.13.5"><title>âœ¨å¾¡å‚ç½‘ç»œ-Javaæ€§èƒ½è°ƒä¼˜ï¼šä¸ºä½•VarHandleæ˜¯å–ä»£åå°„çš„â€œé“¶å¼¹â€ï¼Ÿâœ¨</title><link rel="stylesheet" href="/_astro/index.CVE_tfyK.css">
<style>/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid}}}.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%;position:relative}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88047 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% -.0000298023 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid;--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0}}}.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s));transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.BkXjpIp6.css"><script type="module" src="/_astro/page.V2R8AmkL.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/" class="q0UmqG_navLink">home</a> <a href="/blog/" class="q0UmqG_navLink">blog</a> <a href="/utils/" class="q0UmqG_navLink">utils</a> <a href="/dream-map/" class="inline-block">dream map</a> <a href="/album/" class="q0UmqG_navLink">album</a> <a href="/about-me/" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px]"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">ä½œè€…ï¼šmisakamayako</p>  <p class="text-white text-center mt-2">å‘å¸ƒæ—¶é—´ï¼š2025/08/06</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">ç®€ä»‹</h3> <p class="text-white font-light mb-2">æœ¬æ–‡é€šè¿‡ä¸€ä¸ªç™¾ä¸‡çº§æ•°æ®è§£å¯†çš„åŸºå‡†æµ‹è¯•ï¼Œæ·±å…¥å¯¹æ¯”äº†Javaåå°„ä¸Java 9+ VarHandleåœ¨åŠ¨æ€å­—æ®µä¿®æ”¹åœºæ™¯ä¸‹çš„æ€§èƒ½ã€‚æ–‡ç« ç”¨å®æµ‹æ•°æ®æ¸…æ™°åœ°å±•ç¤ºäº†VarHandleçš„å·¨å¤§ä¼˜åŠ¿ï¼Œå¹¶æ­ç¤ºäº†å…¶â€œä¸€æ¬¡æŸ¥æ‰¾ã€å¤šæ¬¡å¤ç”¨â€çš„é«˜æ•ˆåŸç†ï¼Œæ˜¯ä¸­é«˜çº§å¼€å‘è€…ä¼˜åŒ–æ€§èƒ½ã€æŒæ¡ç°ä»£Javaç‰¹æ€§çš„å¿…è¯»å®è·µã€‚</p> </div> <!-- 2. æ–‡ç« ç›®å½• --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">æœ¬æ–‡ç›®å½•</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. éšæœºæ–‡ç«  --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">éšä¾¿çœ‹çœ‹</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/66edd596bab7/"> å‰ç«¯æ•°æ®å‹ç¼©ä¸è§£å‹ç¼©å®è·µæŒ‡å— </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/2abd28266885/"> æµè§ˆå™¨ç«¯é€šè¿‡File Access APIéšè—ä¸‹è½½å®é™…é“¾æ¥çš„æ–¹æ³• </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/3a01f54a22b0/"> é€šè¿‡ Kotlin åå°„è·å–å±æ€§æ³¨è§£å¹¶è¿›è¡Œæ ¡éªŒ </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-zinc-200 mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-current prose-strong:text-current prose-code:text-current
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>Javaæ€§èƒ½è°ƒä¼˜ï¼šä¸ºä½•VarHandleæ˜¯å–ä»£åå°„çš„â€œé“¶å¼¹â€ï¼Ÿ</h1> </header> <h2 id="æ‘˜è¦">æ‘˜è¦</h2>
<p>åœ¨å¤„ç†æµ·é‡æ•°æ®æ—¶ï¼ŒåŠ¨æ€ä¿®æ”¹å¯¹è±¡å­—æ®µæ˜¯ä¸€é¡¹å¸¸è§ä½†ææ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆçš„æ“ä½œã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Java 9å¼•å…¥çš„<code>VarHandle</code>å¦‚ä½•åœ¨é«˜å¹¶å‘å’Œå¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œä½œä¸ºä¼ ç»Ÿåå°„ï¼ˆReflectionï¼‰çš„ç»§ä»»è€…ï¼Œå®ç°æ•°é‡çº§çš„æ€§èƒ½æå‡ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå…¸å‹çš„â€œå­—æ®µè§£å¯†â€åœºæ™¯ï¼Œç”¨åŸºå‡†æµ‹è¯•æ•°æ®è¯´è¯ï¼Œæ­ç¤º<code>VarHandle</code>èƒŒåçš„â€œé»‘é­”æ³•â€ã€‚</p>
<h2 id="1-ç—›ç‚¹åœºæ™¯å½“ç™¾ä¸‡çº§æ•°æ®é­é‡åå°„å¼è§£å¯†">1. ç—›ç‚¹åœºæ™¯ï¼šå½“ç™¾ä¸‡çº§æ•°æ®é­é‡â€œåå°„å¼â€è§£å¯†</h2>
<p>æƒ³è±¡ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼šæˆ‘ä»¬éœ€è¦ä»æ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶å¤§é‡ï¼ˆä¾‹å¦‚ï¼Œä¸€ç™¾ä¸‡ä¸ªï¼‰ç”¨æˆ·å¯¹è±¡ï¼Œå¹¶å¯¹å…¶ä¸­æ ‡è®°äº†<code>@DecryptField</code>æ³¨è§£çš„æ•æ„Ÿå­—æ®µï¼ˆå¦‚å§“åã€ç”µè¯ï¼‰è¿›è¡Œè§£å¯†ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ETLæˆ–æ•°æ®è„±æ•å‰ç½®å¤„ç†ä»»åŠ¡ã€‚</p>
<h3 id="ä¼ ç»Ÿæ–¹æ¡ˆåå°„reflectionçš„ç›´è§‚ä¸æŒ£æ‰">ä¼ ç»Ÿæ–¹æ¡ˆï¼šåå°„ï¼ˆReflectionï¼‰çš„ç›´è§‚ä¸æŒ£æ‰</h3>
<ul>
<li><strong>å®ç°ç›´è§‚</strong>ï¼šé€šè¿‡<code>Class.getDeclaredFields()</code>ã€<code>field.isAnnotationPresent()</code>å’Œ<code>field.set()</code>ä¸€å¥—ç»„åˆæ‹³ï¼Œä»£ç é€»è¾‘æ¸…æ™°æ˜“æ‡‚ã€‚å¯¹äºä¸€æ¬¡æ€§ä»»åŠ¡æˆ–å°æ‰¹é‡æ•°æ®ï¼Œè¿™æ— ç–‘æ˜¯æœ€å¿«ï¼ˆæŒ‡å¼€å‘é€Ÿåº¦ï¼‰çš„è§£å†³æ–¹æ¡ˆã€‚</li>
<li><strong>æ€§èƒ½ç“¶é¢ˆ</strong>ï¼šå½“æ•°æ®é‡è¾¾åˆ°ç™¾ä¸‡çº§ï¼Œå¾ªç¯å†…éƒ¨çš„<code>field.set()</code>æ“ä½œä¼šæˆä¸ºæ€§èƒ½çš„â€œé‡ç¾åŒºâ€ã€‚ä¸ºä»€ä¹ˆï¼Ÿæˆ‘ä»¬ç¨åæ·±å…¥å‰–æã€‚æˆ‘ä»¬çš„æµ‹è¯•å°†è¯æ˜ï¼Œè¿™ç§ä¾¿åˆ©æ€§æ˜¯ä»¥ç‰ºç‰²æ‰§è¡Œæ•ˆç‡ä¸ºä»£ä»·çš„ã€‚</li>
</ul>
<h2 id="2-æŠ€æœ¯å¯¹æ¯”varhandle-vs-åå°„ä¸€åœºé™ç»´æ‰“å‡»">2. æŠ€æœ¯å¯¹æ¯”ï¼šVarHandle vs. åå°„ï¼Œä¸€åœºâ€œé™ç»´æ‰“å‡»â€</h2>
<p>åœ¨Java 9ä¹‹å‰ï¼Œé¢å¯¹è¿™ç±»éœ€æ±‚æˆ‘ä»¬å¸¸å¸¸å¾—åœ¨â€œä¾¿åˆ©çš„åå°„â€å’Œâ€œé«˜æ€§èƒ½ä½†å¤æ‚çš„å­—èŠ‚ç æ“ä½œâ€ä¹‹é—´åšè‰°éš¾æŠ‰æ‹©ã€‚ä½†ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†<code>VarHandle</code>ã€‚å®ƒå°±åƒæ˜¯ä¸ºæ€§èƒ½è€Œç”Ÿçš„â€œç²¾ç¡®åˆ¶å¯¼å¯¼å¼¹â€ï¼Œè€Œåå°„åˆ™æ›´åƒâ€œåœ°æ¯¯å¼è½°ç‚¸â€ï¼Œè¦†ç›–é¢å¹¿ä½†ç²¾å‡†åº¦å’Œæ•ˆç‡ä¸è¶³ã€‚</p>
<h3 id="21-åå°„reflectionçš„å·¥ä½œåŸç†ä¸å¼€é”€">2.1. åå°„ï¼ˆReflectionï¼‰çš„å·¥ä½œåŸç†ä¸å¼€é”€</h3>
<ul>
<li><strong>åŠ¨æ€çš„â€œå®‰æ£€â€</strong>ï¼šæ¯æ¬¡è°ƒç”¨<code>field.get()</code>æˆ–<code>field.set()</code>ï¼ŒJVMéƒ½éœ€è¦è¿›è¡Œä¸€ç³»åˆ—è¿è¡Œæ—¶æ£€æŸ¥ã€‚è¿™åŒ…æ‹¬ä½†ä¸é™äºï¼šæƒé™æ£€æŸ¥ï¼ˆ<code>setAccessible(true)</code>åªæ˜¯ç»•è¿‡äº†Javaè¯­è¨€çš„è®¿é—®æ§åˆ¶ï¼Œè€ŒéJVMçš„å…¨éƒ¨å®‰å…¨æ£€æŸ¥ï¼‰ã€æ–¹æ³•åŒºæŸ¥æ‰¾ä»¥ç¡®è®¤å­—æ®µæ˜¯å¦å­˜åœ¨ã€ä»¥åŠå¯¹ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹æ ¡éªŒã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨ç™¾ä¸‡æ¬¡å¾ªç¯ä¸­è¢«æ— æƒ…åœ°é‡å¤æ‰§è¡Œï¼Œç´¯ç§¯çš„å¼€é”€ç›¸å½“å¯è§‚ã€‚</li>
<li><strong>â€œè£…ç®±æ‹†ç®±â€çš„éšå½¢æ€æ‰‹</strong>ï¼šåå°„APIæ˜¯åŸºäº<code>Object</code>è®¾è®¡çš„ã€‚è¿™æ„å‘³ç€å³ä½¿æ“ä½œçš„æ˜¯åŸç”Ÿç±»å‹ï¼ˆ<code>int</code>, <code>double</code>ç­‰ï¼‰ï¼Œä¹Ÿå¿…é¡»ç»è¿‡è‡ªåŠ¨è£…ç®±ï¼ˆboxingï¼‰å’Œæ‹†ç®±ï¼ˆunboxingï¼‰çš„è¿‡ç¨‹ï¼Œè¿™ä¼šäº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œç»™GCå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ã€‚</li>
</ul>
<h3 id="22-varhandleç°ä»£javaçš„æŒ‡é’ˆè‰ºæœ¯">2.2. VarHandleï¼šç°ä»£Javaçš„â€œæŒ‡é’ˆâ€è‰ºæœ¯</h3>
<ul>
<li><strong>ä¸€æ¬¡æŸ¥æ‰¾ï¼Œç»ˆèº«å—ç›Š</strong>ï¼š<code>VarHandle</code>çš„æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¥æŸ„åŒ–â€ã€‚æˆ‘ä»¬é€šè¿‡<code>MethodHandles.lookup()</code>åœ¨ç¨‹åºåˆå§‹åŒ–é˜¶æ®µï¼ˆå¾ªç¯å¤–ï¼‰ä¸€æ¬¡æ€§æ‰¾åˆ°ç›®æ ‡å­—æ®µï¼Œå¹¶åˆ›å»ºä¸€ä¸ª<code>VarHandle</code>å®ä¾‹ã€‚è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„æƒé™å’Œç±»å‹æ£€æŸ¥ã€‚ä¸€æ—¦å¥æŸ„åˆ›å»ºæˆåŠŸï¼Œåç»­çš„è°ƒç”¨å°±æ˜¯â€œç›´è¾¾â€å†…å­˜çš„æ“ä½œã€‚</li>
<li><strong>é™æ€ç±»å‹çš„â€œå¿«æ·é€šé“â€</strong>ï¼š<code>VarHandle</code>æ˜¯å¼ºç±»å‹çš„ã€‚å®ƒåœ¨åˆ›å»ºæ—¶ï¼ˆ<code>lookup.findVarHandle(...)</code>ï¼‰å°±å·²ç»é€šè¿‡<code>Class</code>å‚æ•°ç¡®å®šäº†å­—æ®µçš„ç±»å‹ã€‚å› æ­¤ï¼Œåç»­çš„<code>get()</code>å’Œ<code>set()</code>æ“ä½œæ˜¯ç±»å‹ç‰¹å®šçš„ï¼ŒJVMå¯ä»¥è¿›è¡Œæ›´æ·±åº¦çš„ä¼˜åŒ–ï¼Œç”šè‡³å¯èƒ½å†…è”ï¼ˆinlineï¼‰è¿™äº›è°ƒç”¨ï¼Œä½¿å…¶æ€§èƒ½é€¼è¿‘ç›´æ¥çš„å­—æ®µè®¿é—®ã€‚</li>
<li><strong>å¹¶å‘å·¥å…·ç®±çš„åŸºçŸ³</strong>ï¼š<code>VarHandle</code>ä¸ä»…å¿«ï¼Œå®ƒè¿˜æ˜¯Javaç°ä»£å¹¶å‘å·¥å…·çš„åŸºçŸ³ã€‚å®ƒæä¾›äº†æ ‡å‡†çš„å†…å­˜å±éšœè¯­ä¹‰å’Œä¸€å¥—ä¸°å¯Œçš„åŸå­æ“ä½œï¼ˆå¦‚<code>compareAndSet</code>, <code>getAndAdd</code>, <code>getAndBitwiseOr</code>ç­‰ï¼‰ï¼Œè¿™æ­£æ˜¯<code>java.util.concurrent.atomic</code>åŒ…åœ¨Java 9+çš„åº•å±‚å®ç°æ–¹å¼ã€‚</li>
</ul>
<blockquote>
<p><strong>æ ¸å¿ƒç»“è®º</strong>ï¼šåå°„çš„æ€§èƒ½å¼€é”€æ˜¯<strong>æ¯æ¬¡è°ƒç”¨</strong>éƒ½å¿…é¡»æ”¯ä»˜çš„â€œè¿‡è·¯è´¹â€ï¼›è€Œ<code>VarHandle</code>å°†è¿™ç¬”è´¹ç”¨<strong>å¹³æ‘Šåˆ°äº†ä¸€æ¬¡æ€§çš„å¥æŸ„åˆ›å»º</strong>ä¸Šã€‚åœ¨éœ€è¦å¯¹åŒä¸€å­—æ®µè¿›è¡Œå¤§é‡é‡å¤æ“ä½œçš„åœºæ™¯ä¸‹ï¼Œ<code>VarHandle</code>çš„ä¼˜åŠ¿ä¸€ç›®äº†ç„¶ã€‚</p>
</blockquote>
<h2 id="3-æœ€ä½³å®è·µä»£ç åŸºå‡†æµ‹è¯•">3. æœ€ä½³å®è·µï¼šä»£ç åŸºå‡†æµ‹è¯•</h2>
<p>â€œTalk is cheap, show me the code.â€ è®©æˆ‘ä»¬ç”¨ä»£ç æ¥éªŒè¯è¿™ä¸€åˆ‡ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„æµ‹è¯•é¶åœºï¼Œä½¿ç”¨Kotlinç¼–å†™ã€‚</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> java.lang.invoke.MethodHandles</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> kotlin.system.measureTimeMillis</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// å®šä¹‰ä¸€ä¸ªæ³¨è§£ï¼Œç”¨äºæ ‡è®°éœ€è¦è§£å¯†çš„å­—æ®µ</span></span>
<span class="line"><span style="color:#B392F0">@Target</span><span style="color:#E1E4E8">(AnnotationTarget.FIELD)</span></span>
<span class="line"><span style="color:#B392F0">@Retention</span><span style="color:#E1E4E8">(AnnotationRetention.RUNTIME)</span></span>
<span class="line"><span style="color:#F97583">annotation</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> DecryptField</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// æ•°æ®ç±»ï¼ŒåŒ…å«ä¸€äº›éœ€è¦è§£å¯†çš„å­—æ®µ</span></span>
<span class="line"><span style="color:#F97583">data</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> User</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> id: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    @DecryptField</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> name: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    @DecryptField</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> phone: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> email: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    @DecryptField</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> address: </span><span style="color:#B392F0">String</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// æ¨¡æ‹Ÿçš„è§£å¯†å‡½æ•°</span></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> decrypt</span><span style="color:#E1E4E8">(s: </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">): </span><span style="color:#B392F0">String</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "${s}_decoded"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * ä½¿ç”¨ä¼ ç»Ÿåå°„APIè¿›è¡Œè§£å¯†</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> decryptWithReflection</span><span style="color:#E1E4E8">(users: </span><span style="color:#B392F0">List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Any</span><span style="color:#E1E4E8">>) {</span></span>
<span class="line"><span style="color:#6A737D">    // 1. åœ¨å¾ªç¯å¤–ï¼Œé¢„å…ˆæ‰¾å‡ºæ‰€æœ‰éœ€è¦å¤„ç†çš„å­—æ®µã€‚è¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œé¿å…åœ¨ä¸»å¾ªç¯ä¸­é‡å¤è·å–ã€‚</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> fields </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> users[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java.declaredFields</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8"> { it.type </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> String::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> it.</span><span style="color:#B392F0">isAnnotationPresent</span><span style="color:#E1E4E8">(DecryptField::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java) }</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">onEach</span><span style="color:#E1E4E8"> { it.isAccessible </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8"> } </span><span style="color:#6A737D">// å…³é”®ï¼šæ‰“ç ´è®¿é—®é™åˆ¶</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (user </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> users) {</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">field</span><span style="color:#F97583"> in</span><span style="color:#E1E4E8"> fields) {</span></span>
<span class="line"><span style="color:#F97583">            val</span><span style="color:#F97583"> value</span><span style="color:#F97583"> =</span><span style="color:#F97583"> field</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(user) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> String?</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">value</span><span style="color:#F97583"> !=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">                // 2. æ€§èƒ½ç“¶é¢ˆï¼šæ¯æ¬¡setéƒ½ä¼šè§¦å‘JVMçš„åŠ¨æ€æ£€æŸ¥æœºåˆ¶</span></span>
<span class="line"><span style="color:#F97583">                field</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(user, </span><span style="color:#B392F0">decrypt</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">value</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * ä½¿ç”¨Java 9+ çš„VarHandleè¿›è¡Œè§£å¯†</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> decryptWithVarHandle</span><span style="color:#E1E4E8">(users: </span><span style="color:#B392F0">List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Any</span><span style="color:#E1E4E8">>) {</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> clazz </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> users[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">].javaClass</span></span>
<span class="line"><span style="color:#6A737D">    // 1. åˆ›å»ºä¸€ä¸ªæœ‰æƒè®¿é—®ç§æœ‰å­—æ®µçš„Lookupå®ä¾‹</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> lookup </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MethodHandles.</span><span style="color:#B392F0">privateLookupIn</span><span style="color:#E1E4E8">(clazz, MethodHandles.</span><span style="color:#B392F0">lookup</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#6A737D">    // 2. å…³é”®ä¼˜åŒ–ï¼šåœ¨å¾ªç¯å¤–ï¼Œå°†å­—æ®µæŸ¥æ‰¾å’Œæƒé™æ£€æŸ¥çš„å¼€é”€ä¸€æ¬¡æ€§å®Œæˆï¼Œè·å–åˆ°VarHandleå¥æŸ„åˆ—è¡¨</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> handlers </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> clazz.declaredFields</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8"> { it.type </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> String::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> it.</span><span style="color:#B392F0">isAnnotationPresent</span><span style="color:#E1E4E8">(DecryptField::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java) }</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            // è¿™æ­¥åŒ…å«äº†æ‰€æœ‰éªŒè¯å’ŒæŸ¥æ‰¾ï¼Œè¿”å›ä¸€ä¸ªé«˜æ•ˆçš„å­—æ®µè®¿é—®å™¨</span></span>
<span class="line"><span style="color:#E1E4E8">            lookup.</span><span style="color:#B392F0">findVarHandle</span><span style="color:#E1E4E8">(clazz, it.name, String::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (user </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> users) {</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (handle </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> handlers) {</span></span>
<span class="line"><span style="color:#F97583">            val</span><span style="color:#F97583"> value</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> handle.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(user) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> String?</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">value</span><span style="color:#F97583"> !=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">                // 3. é«˜æ€§èƒ½æ“ä½œï¼šæ­¤å¤„çš„setè°ƒç”¨å‡ ä¹ç­‰åŒäºç›´æ¥çš„å­—æ®µèµ‹å€¼ï¼Œå¼€é”€æå°</span></span>
<span class="line"><span style="color:#E1E4E8">                handle.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(user, </span><span style="color:#B392F0">decrypt</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">value</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">    // åˆ›å»ºä¸€ç™¾ä¸‡ä¸ªç”¨æˆ·å¯¹è±¡ç”¨äºæµ‹è¯•</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> userList1 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> List</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1_000_000</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        User</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"id</span><span style="color:#79B8FF">$it</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"name</span><span style="color:#79B8FF">$it</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"phone</span><span style="color:#79B8FF">$it</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"email</span><span style="color:#79B8FF">$it</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"addr</span><span style="color:#79B8FF">$it</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œä¿è¯ä¸¤æ¬¡æµ‹è¯•çš„è¾“å…¥æ•°æ®ä¸€è‡´</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> userList2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> userList1.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> { it.</span><span style="color:#B392F0">copy</span><span style="color:#E1E4E8">() }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Running reflection decryption test..."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> reflectionTime </span><span style="color:#F97583">=</span><span style="color:#B392F0"> measureTimeMillis</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        decryptWithReflection</span><span style="color:#E1E4E8">(userList1)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Reflection time: ${reflectionTime}ms"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Running VarHandle decryption test..."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> varHandleTime </span><span style="color:#F97583">=</span><span style="color:#B392F0"> measureTimeMillis</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        decryptWithVarHandle</span><span style="color:#E1E4E8">(userList2)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"VarHandle time: ${varHandleTime}ms"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">    // è®¡ç®—æ€§èƒ½æå‡ç™¾åˆ†æ¯”</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"time reduce for ${String.</span><span style="color:#B392F0">format</span><span style="color:#9ECBFF">("%.2f%%", (</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> -</span><span style="color:#9ECBFF"> varHandleTime.</span><span style="color:#B392F0">toFloat</span><span style="color:#9ECBFF">() </span><span style="color:#F97583">/</span><span style="color:#9ECBFF"> reflectionTime) </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">)}"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h2 id="4-ç»“æœåˆ†æä¸é¿å‘æŒ‡å—">4. ç»“æœåˆ†æä¸é¿å‘æŒ‡å—</h2>
<h3 id="41-æ€§èƒ½æ•°æ®è§£è¯»">4.1. æ€§èƒ½æ•°æ®è§£è¯»</h3>
<p>æ ¹æ®æˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ç»“æœï¼š</p>
<p><img  loading="lazy" decoding="async" fetchpriority="auto" width="374" height="147" src="/_astro/e3674d143466.iqqaQLgV_2uawsp.webp" ></p>
<ul>
<li><strong>åå°„è€—æ—¶</strong>: 269ms</li>
<li><strong>VarHandleè€—æ—¶</strong>: 119ms</li>
</ul>
<blockquote>
<p>åœ¨æˆ‘ä»¬çš„ç™¾ä¸‡çº§ç”¨æˆ·å¯¹è±¡ã€æ¯ä¸ªå¯¹è±¡3ä¸ªå­—æ®µçš„è§£å¯†æµ‹è¯•ä¸­ï¼ˆæ€»è®¡ä¸‰ç™¾ä¸‡æ¬¡<code>set</code>æ“ä½œï¼‰ï¼Œ<code>VarHandle</code>ç›¸æ¯”ä¼ ç»Ÿåå°„ï¼Œ<strong>å°†æ‰§è¡Œæ—¶é—´ç¼©çŸ­äº†çº¦55.76%</strong>ã€‚è¿™æœ‰åŠ›åœ°è¯å®äº†<code>VarHandle</code>åœ¨é«˜æ€§èƒ½åœºæ™¯ä¸‹çš„ç»å¯¹ä¼˜åŠ¿ã€‚</p>
</blockquote>
<p>å¦‚æœæ“ä½œçš„å­—æ®µæ›´å¤šï¼Œæˆ–è€…æ•°æ®é‡æ›´å¤§ï¼Œè¿™ç§æ€§èƒ½å·®å¼‚å°†æ›´åŠ æ‚¬æ®Šã€‚</p>
<h3 id="42-é¿å‘æŒ‡å—">4.2. é¿å‘æŒ‡å—</h3>
<ul>
<li><strong>ä¸è¦åœ¨å¾ªç¯ä¸­åˆ›å»ºVarHandle</strong>ï¼š<code>VarHandle</code>çš„åˆ›å»ºæ˜¯æœ‰æˆæœ¬çš„ï¼Œå®ƒçš„ä»·å€¼åœ¨äºâ€œä¸€æ¬¡åˆ›å»ºï¼Œå¤šæ¬¡ä½¿ç”¨â€ã€‚è¯·åŠ¡å¿…åœ¨å¾ªç¯å¤–éƒ¨ç¼“å­˜<code>VarHandle</code>å®ä¾‹ã€‚åœ¨å¾ªç¯é‡Œ<code>lookup.findVarHandle</code>ï¼Œæ— å¼‚äºæ¯æ¬¡ä¸Šé«˜é€Ÿéƒ½é‡æ–°å»ºä¸€ä¸ªæ”¶è´¹ç«™ï¼Œæ€§èƒ½ä¼šæ¯”åå°„æ›´å·®ã€‚</li>
<li><strong>æ³¨æ„æ¨¡å—åŒ–ï¼ˆJava 9+ï¼‰çš„è®¿é—®æƒé™</strong>ï¼šåœ¨æ¨¡å—åŒ–çš„Javaé¡¹ç›®ä¸­ï¼Œ<code>MethodHandles.privateLookupIn()</code>èƒ½å¦æˆåŠŸï¼Œå–å†³äºè°ƒç”¨æ–¹æ¨¡å—æ˜¯å¦è¢«æˆæƒå¯ä»¥â€œæ·±åº¦åå°„â€ç›®æ ‡æ¨¡å—ã€‚ä½ å¯èƒ½éœ€è¦åœ¨<code>module-info.java</code>ä¸­<code>opens</code>å¯¹åº”çš„åŒ…ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¦‚æœåªæ˜¯æ¡†æ¶åˆå§‹åŒ–æ—¶ã€æˆ–è€…æŸä¸ªä¸€æ¬¡æ€§å·¥å…·é‡Œè¿›è¡Œå‡ æ¬¡å­—æ®µè®¿é—®ï¼Œåå°„çš„ä¾¿åˆ©æ€§ä¾ç„¶æ˜¯é¦–é€‰ã€‚ä½†åªè¦ä½ çš„åœºæ™¯æ¶‰åŠ<strong>é«˜é¢‘å¾ªç¯</strong>ã€<strong>é«˜å¹¶å‘</strong>æˆ–<strong>åº•å±‚æ¡†æ¶ï¼ˆå¦‚åºåˆ—åŒ–ã€ORMã€AOPï¼‰å¼€å‘</strong>ï¼Œ<code>VarHandle</code>å°±æ˜¯ä¸äºŒä¹‹é€‰ã€‚</li>
</ul>
<h3 id="43-è¶…è¶ŠåŸºç¡€é€šå¾€æ›´åŠ æœºåˆ¶çš„æ€§èƒ½">4.3. è¶…è¶ŠåŸºç¡€ï¼šé€šå¾€æ›´åŠ æœºåˆ¶çš„æ€§èƒ½</h3>
<p>ä¸Šé¢æä¾›çš„ä»£ç åªæ˜¯ä¸€ä¸ªç”¨äºæ¸…æ™°å¯¹æ¯”çš„<strong>æœ€å°åŒ–å¯è¡Œç¤ºä¾‹</strong>ã€‚åœ¨çœŸå®ã€é«˜å¹¶å‘çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ€§èƒ½è°ƒä¼˜çš„æ—…ç¨‹å¹¶æœªåœ¨æ­¤ç»“æŸã€‚æˆ‘ä»¬å¯ä»¥ï¼Œä¹Ÿåº”è¯¥åšå¾—æ›´å¥½ã€‚</p>
<h4 id="1-è·¨è¯·æ±‚çš„å…ƒæ•°æ®ç¼“å­˜">1. è·¨è¯·æ±‚çš„å…ƒæ•°æ®ç¼“å­˜</h4>
<p>æˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œ<code>fields</code>å’Œ<code>handlers</code>æ˜¯åœ¨<code>decryptWith...</code>æ–¹æ³•å†…éƒ¨è®¡ç®—çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœè¿™ä¸ªè§£å¯†æ–¹æ³•è¢«é¢‘ç¹è°ƒç”¨ï¼ˆä¾‹å¦‚ï¼Œæ¯ä¸ªWebè¯·æ±‚æˆ–æ¯ä¸ªMQæ¶ˆæ¯æ¶ˆè´¹éƒ½è°ƒç”¨ä¸€æ¬¡ï¼‰ï¼Œé‚£ä¹ˆæ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡æ–°æ‰§è¡Œä¸€éâ€œæŸ¥æ‰¾æ‰€æœ‰å¸¦æ³¨è§£çš„å­—æ®µ/å¥æŸ„â€çš„é€»è¾‘ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»å°†å…¶ç§»å‡ºäº†ä¸»å¾ªç¯ï¼Œä½†è¿™ä¸ªåˆå§‹åŒ–å¼€é”€ä»ç„¶å¯ä»¥è¢«æ¶ˆé™¤ã€‚</p>
<p><strong>å®è·µæ–¹æ¡ˆï¼š</strong>
åˆ›å»ºä¸€ä¸ªå•ä¾‹çš„æˆ–ç”±ä¾èµ–æ³¨å…¥æ¡†æ¶ç®¡ç†çš„<code>DecryptionService</code>ï¼Œå¹¶åœ¨å…¶å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªé™æ€çš„ã€çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜ã€‚</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> DecryptionService</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    companion</span><span style="color:#F97583"> object</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6A737D">        // ä½¿ç”¨ConcurrentHashMapä½œä¸ºç¼“å­˜ï¼ŒKeyæ˜¯æ•°æ®ç±»ï¼ŒValueæ˜¯å¯¹åº”çš„VarHandleåˆ—è¡¨</span></span>
<span class="line"><span style="color:#F97583">        private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> handleCache </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ConcurrentHashMap</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Class</span><span style="color:#E1E4E8">&#x3C;*>, </span><span style="color:#B392F0">List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">VarHandle</span><span style="color:#E1E4E8">>>()</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    fun</span><span style="color:#B392F0"> decrypt</span><span style="color:#E1E4E8">(target:</span><span style="color:#B392F0">Any</span><span style="color:#E1E4E8">){</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> clazz </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> target.javaClass</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> handles </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> handleCache.</span><span style="color:#B392F0">computeIfAbsent</span><span style="color:#E1E4E8">(clazz){</span></span>
<span class="line"><span style="color:#F97583">            val</span><span style="color:#E1E4E8"> lookup </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MethodHandles.</span><span style="color:#B392F0">privateLookupIn</span><span style="color:#E1E4E8">(clazz, MethodHandles.</span><span style="color:#B392F0">lookup</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">            it.declaredFields</span></span>
<span class="line"><span style="color:#E1E4E8">                .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8"> { </span><span style="color:#F97583">field</span><span style="color:#F97583"> -></span><span style="color:#F97583"> field</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">isAnnotationPresent</span><span style="color:#E1E4E8">(DecryptField::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java)</span><span style="color:#F97583">&#x26;&#x26;field</span><span style="color:#E1E4E8">.type </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> String::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java }</span></span>
<span class="line"><span style="color:#E1E4E8">                .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> { </span><span style="color:#F97583">field</span><span style="color:#F97583"> -></span></span>
<span class="line"><span style="color:#E1E4E8">                    lookup.</span><span style="color:#B392F0">findVarHandle</span><span style="color:#E1E4E8">(it,</span><span style="color:#F97583">field</span><span style="color:#E1E4E8">.name, String::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java)</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#6A737D">        // åç»­å’Œä¹‹å‰ç›¸åŒ</span></span>
<span class="line"><span style="color:#E1E4E8">        handles.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            //...</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šè¿™ç§ç¼“å­˜ç­–ç•¥å®Œç¾è¯ é‡Šäº†<strong>äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Patternï¼‰</strong>ã€‚<code>VarHandle</code>åˆ—è¡¨ä½œä¸ºä¸å˜çš„ã€å¯å…±äº«çš„â€œå†…éƒ¨çŠ¶æ€â€è¢«ç¼“å­˜èµ·æ¥ï¼Œè€Œæ¯æ¬¡éœ€è¦æ“ä½œçš„å¯¹è±¡åˆ™æ˜¯æ˜“å˜çš„â€œå¤–éƒ¨çŠ¶æ€â€ã€‚è¿™ä½¿å¾—è·å–å­—æ®µæ“ä½œå¥æŸ„çš„æˆæœ¬ä»â€œæ¯æ¬¡è°ƒç”¨â€é™ä½åˆ°äº†â€œåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…ä»…ä¸€æ¬¡â€ã€‚</p>
</blockquote>
<h2 id="5-æ€»ç»“æ‹¥æŠ±æœªæ¥æ˜æ™ºé€‰æ‹©">5. æ€»ç»“ï¼šæ‹¥æŠ±æœªæ¥ï¼Œæ˜æ™ºé€‰æ‹©</h2>
<p>Javaçš„æ¼”è¿›ä»æœªåœæ­¢ã€‚<code>VarHandle</code>çš„å‡ºç°ï¼Œå¹¶éè¦å®Œå…¨æ¶ˆç­åå°„ï¼Œè€Œæ˜¯ä¸ºå¼€å‘è€…åœ¨æ€§èƒ½å’Œçµæ´»æ€§ä¹‹é—´æä¾›äº†æ›´ç²¾ç»†çš„æƒè¡¡ã€‚å®ƒèµ‹äºˆäº†æˆ‘ä»¬ä»¥æ¥è¿‘æœ¬åœ°ä»£ç çš„æ•ˆç‡å»æ“ä½œå¯¹è±¡å­—æ®µçš„èƒ½åŠ›ï¼ŒåŒæ—¶è¿˜æä¾›äº†å¼ºå¤§çš„å¹¶å‘æ§åˆ¶åŸè¯­ã€‚</p>
<p>ä½œä¸ºè¿½æ±‚å“è¶Šæ€§èƒ½çš„å¼€å‘è€…ï¼Œä¸‹æ¬¡å½“æ‚¨é¢ä¸´ç±»ä¼¼çš„æŒ‘æˆ˜æ—¶ï¼Œè¯·è®°ä½ï¼š<strong>åœ¨æ€§èƒ½çš„åå­—è·¯å£ï¼Œ<code>VarHandle</code>æ˜¯é€šå¾€æœªæ¥çš„é«˜é€Ÿå…¬è·¯ã€‚</strong></p>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin/">Kotlin</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/æ€§èƒ½ä¼˜åŒ–/">æ€§èƒ½ä¼˜åŒ–</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/åå°„/">åå°„</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/JVM/">JVM</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">ğŸ“«</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div> <script type="module" is:global>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach((block) => {
                const button = document.createElement('button')
                button.innerText = 'å¤åˆ¶'
                button.className =
                    'absolute top-2 right-2 bg-slate-800 text-white px-2 py-1 rounded text-sm opacity-50 hover:opacity-100 transition cursor-pointer'
                button.addEventListener('click', () => {
                    const code = block.querySelector('code')
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerText = 'å·²å¤åˆ¶ï¼'
                            setTimeout(() => (button.innerText = 'å¤åˆ¶'), 1000)
                        })
                    }
                })
                block.classList.add('relative')
                block.appendChild(button)
            })
        })
    </script>  </body></html>