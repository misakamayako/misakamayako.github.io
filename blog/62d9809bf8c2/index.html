<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="-RgOsAO7rMTpJ8vNk8-ILdAA8VmiTEUc9HiUVVTKeEs"><meta name="generator" content="Astro v5.16.11"><title>âœ¨å¾¡å‚ç½‘ç»œ-Jetpack Compose ä¸­ä½¿ç”¨ Server-Sent Eventsï¼ˆSSEï¼‰âœ¨</title><link rel="stylesheet" href="/_astro/index.CaRWMvsr.css">
<style>/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid}}}.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%;position:relative}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88044 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% 0 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid;--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0}}}.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% 0 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% 0 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% 0 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.Ch7HxPFz.css"><script type="module" src="/_astro/page.D1uwR3nK.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/" class="q0UmqG_navLink">home</a> <a href="/blog/" class="q0UmqG_navLink">blog</a> <a href="/utils/" class="q0UmqG_navLink">utils</a> <a href="/dream-map/" class="inline-block">dream map</a> <a href="/album/" class="q0UmqG_navLink">album</a> <a href="/about-me/" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px] overflow-auto"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">ä½œè€…ï¼šmisakamayako</p>  <p class="text-white text-center mt-2">å‘å¸ƒæ—¶é—´ï¼š2024/07/04</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">ç®€ä»‹</h3> <p class="text-white font-light mb-2">æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åœ¨ Jetpack Compose ä¸­ç»“åˆ Retrofitã€Flow ä¸ Streaming å®ç°æœåŠ¡ç«¯äº‹ä»¶æµï¼ˆSSEï¼‰æœºåˆ¶ï¼Œé€šè¿‡å“åº”å¼æ–¹å¼å®æ—¶æ›´æ–°è§†å›¾ï¼Œé€‚ç”¨äºéœ€è¦æµå¼å“åº”çš„åœºæ™¯ã€‚</p> </div> <!-- 2. æ–‡ç« ç›®å½• --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">æœ¬æ–‡ç›®å½•</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. éšæœºæ–‡ç«  --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">éšä¾¿çœ‹çœ‹</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/2ed8a0ceb014/"> WebGPU vs CPUï¼šå¹¶è¡Œè®¡ç®—æ€§èƒ½å®æµ‹å¯¹æ¯” </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/d2c826b611c2/"> æµè§ˆå™¨ç«¯å¼‚æ­¥æµæ•°æ®èµ„æºç®¡ç† </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/66edd596bab7/"> å‰ç«¯æ•°æ®å‹ç¼©ä¸è§£å‹ç¼©å®è·µæŒ‡å— </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-zinc-200 mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-current prose-strong:text-current prose-code:text-current
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>Jetpack Compose ä¸­ä½¿ç”¨ Server-Sent Eventsï¼ˆSSEï¼‰</h1> </header> <h3 id="1-æ¥å£å®šä¹‰éƒ¨åˆ†">1. æ¥å£å®šä¹‰éƒ¨åˆ†</h3>
<p>ä½¿ç”¨<code>retrofit2.http.Streaming</code>æ³¨è§£ï¼Œå°†ä¸€ä¸ªæ¥å£çš„è¿”å›æ•°æ®å®šä¹‰ä¸ºstream</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583"> import</span><span style="color:#B392F0"> okhttp3.ResponseBody</span></span>
<span class="line"><span style="color:#F97583"> import</span><span style="color:#B392F0"> retrofit2.Response</span></span>
<span class="line"><span style="color:#F97583"> import</span><span style="color:#B392F0"> retrofit2.http.Body</span></span>
<span class="line"><span style="color:#F97583"> import</span><span style="color:#B392F0"> retrofit2.http.POST</span></span>
<span class="line"><span style="color:#F97583"> import</span><span style="color:#B392F0"> retrofit2.http.Streaming</span></span>
<span class="line"><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#F97583"> interface</span><span style="color:#B392F0"> API</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">     @POST</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/v1/api/createSomeThing"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">     @Streaming</span></span>
<span class="line"><span style="color:#6A737D">     /// æ¥å£è¿”å›å€¼ç±»å‹å®šä¹‰å¿…é¡»ä¸ºResponseBodyï¼Œè€Œä¸æ˜¯å†…å®¹çš„ç±»å‹</span></span>
<span class="line"><span style="color:#F97583">     suspend</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> createCompletion</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">@Body</span><span style="color:#E1E4E8"> formData: </span><span style="color:#B392F0">FormData</span><span style="color:#E1E4E8">): </span><span style="color:#B392F0">Response</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ResponseBody</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8"> }</span></span></code></pre>
<h3 id="2-æ¥å£ä½¿ç”¨">2. æ¥å£ä½¿ç”¨</h3>
<p>å› ä¸ºéœ€æ±‚åœ¨æ¯æ¬¡è·å–åˆ°æ•°æ®æ—¶ç«‹åˆ»æ›´æ–°è§†å›¾ï¼Œæ‰€ä»¥æœ¬æ¬¡ä½¿ç”¨äº†<a href="https://kotlinlang.org/docs/flow.html">flow</a>,
å¦‚æœæ²¡æœ‰åœ¨æ¯æ¬¡è·å–æ•°æ®æ—¶ç«‹åˆ»æ›´æ–°è§†å›¾çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨æ™®é€šçš„<code>suspend fun</code>ï¼Œå¹¶ä¸”åœ¨<code>emit</code>çš„éƒ¨åˆ†ç»„åˆä½ çš„æ•°æ®,ä¸‹é¢è¿™æ˜¯ä¸€ä¸ªå®ç°çš„ä¾‹å­ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#6A737D">// åŠ è½½å¿…è¦çš„åº“</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> kotlinx.coroutines.</span><span style="color:#79B8FF">*</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> kotlinx.coroutines.flow.flow</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> kotlinx.serialization.decodeFromString</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> kotlinx.serialization.json.Json</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> okio.IOException</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> retrofit2.HttpException</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ä»æœåŠ¡å™¨ç«¯è·å–Response</span></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> getResponse</span><span style="color:#E1E4E8">(message: </span><span style="color:#B392F0">Message</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=</span><span style="color:#B392F0"> flow</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    coroutineScope</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            // åˆ›å»ºAPIå®ä¾‹</span></span>
<span class="line"><span style="color:#F97583">            val</span><span style="color:#E1E4E8"> response </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> retrofit.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(API::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java).</span><span style="color:#B392F0">createCompletion</span><span style="color:#E1E4E8">(message)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (response.isSuccessful) {</span></span>
<span class="line"><span style="color:#6A737D">                // è·å–è¯·æ±‚çš„è¾“å…¥æµ</span></span>
<span class="line"><span style="color:#F97583">                val</span><span style="color:#E1E4E8"> input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> response.</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">()?.</span><span style="color:#B392F0">byteStream</span><span style="color:#E1E4E8">()?.</span><span style="color:#B392F0">bufferedReader</span><span style="color:#E1E4E8">() ?: </span><span style="color:#F97583">throw</span><span style="color:#B392F0"> Exception</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">                try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                    while</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">currentCoroutineContext</span><span style="color:#E1E4E8">().isActive) {</span></span>
<span class="line"><span style="color:#6A737D">                        // ä»æœåŠ¡å™¨ç«¯æ¥æ”¶æ¯è¡Œæ•°æ®</span></span>
<span class="line"><span style="color:#F97583">                        val</span><span style="color:#E1E4E8"> line </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#B392F0">                            withContext</span><span style="color:#E1E4E8">(Dispatchers.IO) {</span></span>
<span class="line"><span style="color:#E1E4E8">                                input.</span><span style="color:#B392F0">readLine</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">                            } ?: </span><span style="color:#F97583">continue</span></span>
<span class="line"><span style="color:#6A737D">                        // åˆ¤æ–­æ˜¯å¦ä¸ºç©ºè¡Œï¼Œè‹¥æ˜¯åˆ™è·³è¿‡</span></span>
<span class="line"><span style="color:#F97583">                        if</span><span style="color:#E1E4E8"> (line.</span><span style="color:#B392F0">startsWith</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"data:"</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> line </span><span style="color:#F97583">!=</span><span style="color:#9ECBFF"> "data: [DONE]"</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                            try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">                                // å°†æ¯è¡Œæ•°æ®è½¬æ¢ä¸ºStreamChatCompletion</span></span>
<span class="line"><span style="color:#F97583">                                val</span><span style="color:#E1E4E8"> streamChatCompletion </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#E1E4E8">                                    Json.</span><span style="color:#B392F0">decodeFromString</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">StreamChatCompletion</span><span style="color:#E1E4E8">>(</span></span>
<span class="line"><span style="color:#E1E4E8">                                        line.</span><span style="color:#B392F0">substring</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">trim</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                                    )</span></span>
<span class="line"><span style="color:#6A737D">                                // å‘é€æ•°æ®</span></span>
<span class="line"><span style="color:#B392F0">                                emit</span><span style="color:#E1E4E8">(streamChatCompletion)</span></span>
<span class="line"><span style="color:#E1E4E8">                            } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e: </span><span style="color:#B392F0">Exception</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                                e.</span><span style="color:#B392F0">printStackTrace</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">                            }</span></span>
<span class="line"><span style="color:#E1E4E8">                        } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (line </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> "data: [DONE]"</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                            break</span></span>
<span class="line"><span style="color:#E1E4E8">                        }</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e: </span><span style="color:#B392F0">IOException</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                    throw</span><span style="color:#B392F0"> Exception</span><span style="color:#E1E4E8">(e)</span></span>
<span class="line"><span style="color:#E1E4E8">                } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">                    withContext</span><span style="color:#E1E4E8">(Dispatchers.IO) {</span></span>
<span class="line"><span style="color:#E1E4E8">                        input.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">            } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                throw</span><span style="color:#B392F0"> HttpException</span><span style="color:#E1E4E8">(response)</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (_: </span><span style="color:#B392F0">Throwable</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            ToastService.</span><span style="color:#B392F0">toast</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"è¿æ¥æœåŠ¡å™¨å¤±è´¥"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"æœåŠ¡å™¨å“åº”å¤±è´¥"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="3-composeä¸­çš„ä½¿ç”¨">3. composeä¸­çš„ä½¿ç”¨</h3>
<p>å°†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä½œä¸ºç”¨æˆ·æ“ä½œçš„å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚buttonçš„onclickäº‹ä»¶ä¸­</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> foo</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">   //åœ¨åç¨‹ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç </span></span>
<span class="line"><span style="color:#E1E4E8">   scope.</span><span style="color:#B392F0">launch</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">       //å°†loadingStatusè®¾ç½®ä¸ºtrue</span></span>
<span class="line"><span style="color:#E1E4E8">       loadingStatus </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#6A737D">       //å°†lastMessageè®¾ç½®ä¸ºuserMessage</span></span>
<span class="line"><span style="color:#F97583">       val</span><span style="color:#E1E4E8"> lastMessage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> userMessage</span></span>
<span class="line"><span style="color:#6A737D">       //å°†ChatMessageæ·»åŠ åˆ°messageListä¸­</span></span>
<span class="line"><span style="color:#E1E4E8">       messageList.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">           ChatMessage</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">               mutableStateOf</span><span style="color:#E1E4E8">(lastMessage), </span><span style="color:#6A737D">//æ¶ˆæ¯å†…å®¹ä¸ºlastMessage</span></span>
<span class="line"><span style="color:#79B8FF">               false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">               System.</span><span style="color:#B392F0">currentTimeMillis</span><span style="color:#E1E4E8">()</span><span style="color:#6A737D">//æ¶ˆæ¯æ—¶é—´æˆ³ä¸ºå½“å‰æ—¶é—´</span></span>
<span class="line"><span style="color:#E1E4E8">           )</span></span>
<span class="line"><span style="color:#E1E4E8">       )</span></span>
<span class="line"><span style="color:#6A737D">       //å®šä¹‰ä¸€ä¸ªåä¸ºflagçš„å¸ƒå°”å˜é‡å¹¶å°†å…¶è®¾ç½®ä¸ºfalse</span></span>
<span class="line"><span style="color:#F97583">       var</span><span style="color:#E1E4E8"> flag </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#6A737D">       //å°†userMessageè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#E1E4E8">       userMessage </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#F97583">       try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">           val</span><span style="color:#E1E4E8"> responseMessage </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ChatMessage</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">               mutableStateOf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">),</span><span style="color:#6A737D">//æ¶ˆæ¯å†…å®¹ä¸ºç©ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#79B8FF">               true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">               System.</span><span style="color:#B392F0">currentTimeMillis</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 50L</span><span style="color:#6A737D">//æ¶ˆæ¯æ—¶é—´æˆ³ä¸ºå½“å‰æ—¶é—´åŠ 50</span></span>
<span class="line"><span style="color:#E1E4E8">           )</span></span>
<span class="line"><span style="color:#6A737D">           //ä»ChatMainDataSourceä¸­è·å–çš„å“åº”</span></span>
<span class="line"><span style="color:#E1E4E8">           ChatMainDataSource.</span><span style="color:#B392F0">getResponse</span><span style="color:#E1E4E8">(lastMessage).</span><span style="color:#B392F0">collect</span><span style="color:#E1E4E8"> { </span><span style="color:#F97583">data</span><span style="color:#F97583"> -></span></span>
<span class="line"><span style="color:#6A737D">               //å°†çš„å“åº”æ·»åŠ åˆ°responseMessageçš„æ¶ˆæ¯å†…å®¹ä¸­</span></span>
<span class="line"><span style="color:#E1E4E8">               responseMessage.message.</span><span style="color:#B392F0">setValue</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                   responseMessage,</span><span style="color:#6A737D">//è®¾ç½®æ–°çš„å€¼</span></span>
<span class="line"><span style="color:#E1E4E8">                   responseMessage::</span><span style="color:#B392F0">message</span><span style="color:#E1E4E8">,</span><span style="color:#6A737D">//ä½¿ç”¨çš„å±æ€§</span></span>
<span class="line"><span style="color:#E1E4E8">                   (responseMessage.message.</span><span style="color:#F97583">value</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">data</span><span style="color:#E1E4E8">.choices[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">].delta.content?:</span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">trim</span><span style="color:#E1E4E8">())</span><span style="color:#6A737D">//æ–°çš„æ¶ˆæ¯å†…å®¹ä¸ºåŸå§‹å†…å®¹ä¸å“åº”çš„å†…å®¹çš„æ‹¼æ¥</span></span>
<span class="line"><span style="color:#E1E4E8">               )</span></span>
<span class="line"><span style="color:#6A737D">               //å¦‚æœflagä¸ºfalseï¼Œåˆ™å°†responseMessageæ·»åŠ åˆ°messageListä¸­</span></span>
<span class="line"><span style="color:#F97583">               if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">flag) {</span></span>
<span class="line"><span style="color:#E1E4E8">                   messageList.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(responseMessage)</span></span>
<span class="line"><span style="color:#E1E4E8">               }</span></span>
<span class="line"><span style="color:#6A737D">               //å°†flagè®¾ç½®ä¸ºtrue</span></span>
<span class="line"><span style="color:#E1E4E8">               flag </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#E1E4E8">       } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (_: </span><span style="color:#B392F0">Throwable</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">           //å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™å°†userMessageè®¾ç½®ä¸ºlastMessage</span></span>
<span class="line"><span style="color:#E1E4E8">           userMessage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lastMessage</span></span>
<span class="line"><span style="color:#6A737D">           //ç„¶åå°†messageListä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ç§»é™¤</span></span>
<span class="line"><span style="color:#E1E4E8">           messageList.</span><span style="color:#B392F0">removeLast</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">           //å¦‚æœflagä¸ºtrueï¼Œåˆ™å†æ¬¡å°†messageListä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ç§»é™¤</span></span>
<span class="line"><span style="color:#F97583">           if</span><span style="color:#E1E4E8"> (flag) {</span></span>
<span class="line"><span style="color:#E1E4E8">               messageList.</span><span style="color:#B392F0">removeLast</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#E1E4E8">       } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">           //å°†loadingStatusè®¾ç½®ä¸ºfalse</span></span>
<span class="line"><span style="color:#E1E4E8">           loadingStatus </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Jetpack Compose/">Jetpack Compose</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/SSE/">SSE</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Retrofit/">Retrofit</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin åç¨‹/">Kotlin åç¨‹</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">ğŸ“«</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div> <script type="module" is:global>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach((block) => {
                const button = document.createElement('button')
                button.innerText = 'å¤åˆ¶'
                button.className =
                    'absolute top-2 right-2 bg-slate-800 text-white px-2 py-1 rounded text-sm opacity-50 hover:opacity-100 transition cursor-pointer'
                button.addEventListener('click', () => {
                    const code = block.querySelector('code')
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerText = 'å·²å¤åˆ¶ï¼'
                            setTimeout(() => (button.innerText = 'å¤åˆ¶'), 1000)
                        })
                    }
                })
                block.classList.add('relative')
                block.appendChild(button)
            })
        })
    </script>  </body></html>