<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="-RgOsAO7rMTpJ8vNk8-ILdAA8VmiTEUc9HiUVVTKeEs"><meta name="generator" content="Astro v5.16.9"><title>âœ¨å¾¡å‚ç½‘ç»œ-JDK 22 FFM API ä¸ä¼ ç»Ÿ JNI çš„å¯¹æ¯”âœ¨</title><link rel="stylesheet" href="/_astro/index.BT8t14_1.css">
<style>/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid}}}.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%;position:relative}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88047 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% -.0000298023 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid;--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0}}}.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.BOOrbLic.css"><script type="module" src="/_astro/page.D1uwR3nK.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/" class="q0UmqG_navLink">home</a> <a href="/blog/" class="q0UmqG_navLink">blog</a> <a href="/utils/" class="q0UmqG_navLink">utils</a> <a href="/dream-map/" class="inline-block">dream map</a> <a href="/album/" class="q0UmqG_navLink">album</a> <a href="/about-me/" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px] overflow-auto"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">ä½œè€…ï¼šmisakamayako</p>  <p class="text-white text-center mt-2">å‘å¸ƒæ—¶é—´ï¼š2025/08/01</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">ç®€ä»‹</h3> <p class="text-white font-light mb-2">æœ¬æ–‡å…¨é¢å¯¹æ¯”äº† JDK 22 å¼•å…¥çš„ Foreign Function &amp; Memory APIï¼ˆFFM APIï¼‰ä¸ä¼ ç»Ÿ Java Native Interfaceï¼ˆJNIï¼‰åœ¨æ¶æ„è®¾è®¡ã€æ€§èƒ½ã€å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§ã€è·¨å¹³å°å…¼å®¹æ€§ç­‰æ–¹é¢çš„å¼‚åŒä¸ä¼˜åŠ£ã€‚å¹¶æ·±å…¥æ¢è®¨äº† C/C++ ä»£ç åœ¨ä¸¤ç§è°ƒç”¨æ–¹å¼ä¸‹æ˜¯å¦éœ€è¦ä¸åŒå®ç°ï¼Œä»¥åŠåœ¨å®é™…é¡¹ç›®ä¸­å¦‚ä½•é€‰æ‹©æ›´åˆé€‚çš„æœ¬åœ°äº’æ“ä½œæŠ€æœ¯ã€‚</p> </div> <!-- 2. æ–‡ç« ç›®å½• --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">æœ¬æ–‡ç›®å½•</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. éšæœºæ–‡ç«  --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">éšä¾¿çœ‹çœ‹</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/cdd26be77a2a/"> æ•°æ®åº“è®¾è®¡çš„å…­ç§èŒƒå¼ </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/b9f6e3979a1b/"> Reactor Core Monoé™æ€æ–¹æ³•è¯¦è§£ </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/8b40690e60a0/"> BroadcastChannel API æ¦‚è¿° </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-zinc-200 mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-current prose-strong:text-current prose-code:text-current
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>JDK 22 FFM API ä¸ä¼ ç»Ÿ JNI çš„å¯¹æ¯”</h1> </header> <p>JDK 22 å¼•å…¥äº†<strong>å¤–éƒ¨å‡½æ•°å’Œå†…å­˜ APIï¼ˆFFM APIï¼‰</strong>ï¼Œæä¾›äº†ä¸€ç§å…¨æ–°çš„ Java ä¸æœ¬åœ°ä»£ç äº’æ“ä½œæ–¹æ¡ˆã€‚ä¸ä¼ ç»Ÿçš„ JNI ç›¸æ¯”ï¼ŒFFM API é‡‡ç”¨çº¯ Java çš„ç¼–ç¨‹æ¨¡å‹ï¼Œé€šè¿‡ <code>Linker</code>ã€<code>MethodHandle</code>ã€<code>MemorySegment</code> ç­‰ç±»ç›´æ¥è°ƒç”¨ C å‡½æ•°å’Œç®¡ç†æœ¬åœ°å†…å­˜ï¼Œæ— éœ€ç¼–å†™ JNI Glue ä»£ç æˆ–ç”Ÿæˆå¤´æ–‡ä»¶ã€‚ä¸‹é¢ä»æ¶æ„è®¾è®¡ã€æ€§èƒ½ã€å®‰å…¨ã€å¯ç»´æŠ¤æ€§ã€æ˜“ç”¨æ€§ã€è·¨å¹³å°å…¼å®¹æ€§ç­‰ç»´åº¦è¯¦ç»†å¯¹æ¯”ä¸¤è€…çš„å·®å¼‚ä¸ä¼˜åŠ£ï¼Œå¹¶è®¨è®º C/C++ ä»£ç å®ç°å’Œé€‚ç”¨åœºæ™¯ã€‚</p>
<h2 id="æ¶æ„è®¾è®¡ä¸è°ƒç”¨æ–¹å¼">æ¶æ„è®¾è®¡ä¸è°ƒç”¨æ–¹å¼</h2>
<ul>
<li>
<p><strong>JNI</strong>ï¼šJava ä¾§é€šè¿‡ <code>native</code> å…³é”®å­—å£°æ˜æœ¬åœ°æ–¹æ³•ï¼ˆæ— æ–¹æ³•ä½“ï¼‰ï¼Œå¹¶ä½¿ç”¨ <code>System.loadLibrary</code> åŠ è½½æœ¬åœ°åº“ã€‚å¯¹åº”çš„ C/C++ ä»£ç å¿…é¡»ä½¿ç”¨ JNI è§„èŒƒçš„å‡½æ•°ç­¾åï¼Œå½¢å¼å¦‚ <code>Java_åŒ…å_ç±»å_æ–¹æ³•å(JNIEnv *env, jclass/jobject, å‚æ•°â€¦)</code>ã€‚è°ƒç”¨æ—¶ï¼ŒJava ä¸æœ¬åœ°ä»£ç ä¹‹é—´é€šè¿‡ <code>JNIEnv</code> ç»“æ„ä½“æŒ‡é’ˆè¿›è¡Œäº¤äº’ï¼šJava å€¼éœ€è¦è½¬æ¢ä¸º JNI ç±»å‹ï¼ˆå¦‚ <code>jintArray</code>ã€<code>jstring</code> ç­‰ï¼‰ï¼ŒC ä»£ç é€šè¿‡ <code>(*env)->GetXXX</code> ç³»åˆ—å‡½æ•°è®¿é—®æ•°æ®æˆ–è°ƒç”¨ Java æ–¹æ³•ã€‚æ•´ä¸ªè°ƒç”¨æ¨¡å‹åå‘â€œNative ä¼˜å…ˆâ€ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æ•°ç»„/å­—ç¬¦ä¸²æ‹·è´ã€å¼•ç”¨ç®¡ç†å’Œå¼‚å¸¸æ£€æŸ¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨ JNI è°ƒç”¨ C å‡½æ•°å¹¶è¿”å›æ•´æ•°çš„ç¤ºä¾‹ï¼š</p>
</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">external</span><span style="color:#F97583"> fun</span><span style="color:#B392F0"> add</span><span style="color:#E1E4E8">(a: </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8">, b: </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8">): </span><span style="color:#B392F0">Int</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    System.</span><span style="color:#B392F0">loadLibrary</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"native"</span><span style="color:#E1E4E8">)  </span><span style="color:#6A737D">// ç›´æ¥åœ¨mainé‡ŒåŠ è½½</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">))            </span><span style="color:#6A737D">// è°ƒç”¨nativeæ–¹æ³•</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>å¯¹åº”çš„ C/C++ å®ç°ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;jni.h></span></span>
<span class="line"><span style="color:#E1E4E8">JNIEXPORT jint JNICALL </span><span style="color:#B392F0">Java_MainKt_add</span><span style="color:#E1E4E8">(JNIEnv </span><span style="color:#F97583">*</span><span style="color:#FFAB70">env</span><span style="color:#E1E4E8">, jclass </span><span style="color:#FFAB70">cls</span><span style="color:#E1E4E8">, jint </span><span style="color:#FFAB70">a</span><span style="color:#E1E4E8">, jint </span><span style="color:#FFAB70">b</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> a </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> b;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<ul>
<li><strong>FFM API</strong>ï¼šJava ä¾§ä½¿ç”¨ <code>java.lang.foreign</code> åŒ…æä¾›çš„ç±»ã€‚é€šè¿‡ <code>Linker</code> æŸ¥æ‰¾å¹¶ç»‘å®šæœ¬åœ°å‡½æ•°åœ°å€ï¼Œç„¶åä½¿ç”¨ <code>MethodHandle</code> è°ƒç”¨â€œä¸‹æº¢è°ƒç”¨â€ï¼ˆdowncallï¼‰ã€‚åŒæ—¶ä½¿ç”¨ <code>MemorySegment</code>ï¼ˆå’Œ <code>Arena</code>ï¼‰åˆ†é…å¹¶ç®¡ç†æœ¬åœ°å†…å­˜ã€‚æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹çº¯ç²¹åœ¨ Java ä¸­å®Œæˆï¼Œæ— éœ€ä»»ä½• JNI C ä»£ç ã€‚FFM çš„è®¾è®¡ç›®æ ‡æ˜¯â€œ<strong>Java ä¼˜å…ˆ</strong>â€ï¼Œå³åœ¨ Java ä»£ç ä¸­ç›´æ¥æè¿°è°ƒç”¨ç­¾åå’Œå†…å­˜å¸ƒå±€ï¼Œå†ç”±åº•å±‚è‡ªåŠ¨è¿›è¡Œå‚æ•°æ‹·è´å’Œå†…å­˜ç®¡ç†ã€‚å¦‚ä¸‹ç¤ºä¾‹é€šè¿‡ FFM API è°ƒç”¨ C åº“ä¸­çš„ <code>add</code>ï¼š</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Arena.</span><span style="color:#B392F0">ofConfined</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">use</span><span style="color:#E1E4E8"> { arena </span><span style="color:#F97583">-></span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#E1E4E8"> linker </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Linker.</span><span style="color:#B392F0">nativeLinker</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#E1E4E8"> os </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">getProperty</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"os.name"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">lowercase</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">  // åŠ è½½åŠ¨æ€åº“</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#E1E4E8"> libPath </span><span style="color:#F97583">=</span><span style="color:#F97583"> when</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    os.</span><span style="color:#B392F0">contains</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"win"</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#9ECBFF"> "native.dll"</span></span>
<span class="line"><span style="color:#E1E4E8">    os.</span><span style="color:#B392F0">contains</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"mac"</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#9ECBFF"> "libnative.dylib"</span></span>
<span class="line"><span style="color:#F97583">    else</span><span style="color:#F97583"> -></span><span style="color:#9ECBFF"> "libnative.so"</span><span style="color:#6A737D"> // Linux/BSD</span></span>
<span class="line"><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#E1E4E8"> symbolLookup </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> SymbolLookup.</span><span style="color:#B392F0">libraryLookup</span><span style="color:#E1E4E8">(libPath, arena)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // æŸ¥æ‰¾ add å‡½æ•°ç¬¦å·</span></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#E1E4E8"> addHandle: </span><span style="color:#B392F0">MethodHandle</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> linker.</span><span style="color:#B392F0">downcallHandle</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      symbolLookup.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"add"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">orElseThrow</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      FunctionDescriptor.</span><span style="color:#B392F0">of</span><span style="color:#E1E4E8">(ValueLayout.JAVA_INT, ValueLayout.JAVA_INT, ValueLayout.JAVA_INT)</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  val</span><span style="color:#E1E4E8"> result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> addHandle.</span><span style="color:#B392F0">invoke</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> Int</span></span>
<span class="line"><span style="color:#B392F0">  println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"3 + 5 = </span><span style="color:#79B8FF">$result</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>å¯¹åº”çš„ C/C++ å®ç°ï¼š</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">  int</span><span style="color:#B392F0"> add</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> a</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">int</span><span style="color:#FFAB70"> b</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> a </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> b;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span></code></pre>
<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ²¡æœ‰ä»»ä½• JNI å¤´æ–‡ä»¶æˆ– C ä»£ç å®šä¹‰ï¼›æ‰€æœ‰ç»‘å®šã€ç­¾åå’Œå†…å­˜ç®¡ç†éƒ½åœ¨ Java ç«¯å®Œæˆã€‚è¡¨æ˜ FFM API è®©â€œçº¯ Java ä¸æœ¬åœ°ä»£ç å¯¹è¯â€ï¼Œä¸éœ€è¦ JNI Glue ä»£ç ã€‚è¿™ç§è®¾è®¡ç®€åŒ–äº†è°ƒç”¨è¿‡ç¨‹ï¼šJava ä»£ç ç”¨ <code>FunctionDescriptor</code> å®šä¹‰å‡½æ•°ç­¾åï¼Œç”¨ <code>MemorySegment</code> è¡¨ç¤ºæœ¬åœ°ç¼“å†²åŒºï¼Œè°ƒç”¨ç»“æŸå <code>Arena</code> è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚</p>
<ul>
<li><strong>æ•°æ®å’Œå†…å­˜ä¼ é€’</strong>ï¼šJNI åŸæœ¬åªæ”¯æŒåŸºæœ¬ç±»å‹å’Œ Java å¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆéœ€è¦å€ŸåŠ© <code>GetXXXArrayElements</code>ã€<code>GetStringUTFChars</code> ç­‰æ–¹æ³•å¤„ç†æ•°æ®ï¼‰ï¼Œè€Œ FFM API æä¾›äº†çµæ´»çš„å†…å­˜æ“ä½œæ¥å£ã€‚Java å¯é€šè¿‡ <code>MemorySegment</code> å¯¹è±¡ç›´æ¥æ˜ å°„ä»»æ„ç»“æ„ä½“ï¼Œä½¿ç”¨ <code>MemoryLayout</code>/<code>VarHandle</code> æ–¹ä¾¿åœ°è¯»å†™æœ¬åœ°æ•°æ®ç»“æ„ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ç›´æ¥å®šä¹‰ C ç»“æ„ä½“å¸ƒå±€ï¼Œåˆ†é… <code>MemorySegment</code> å¹¶è¯»å†™å­—æ®µï¼Œé¿å…æ‰‹åŠ¨è®¡ç®—åç§»ã€‚FFM å–ä»£äº† JNI ä¸­éš¾ç”¨çš„ <code>DirectByteBuffer</code> æ–¹æ¡ˆï¼Œæä¾›äº†æ›´å®‰å…¨ã€æ›´ç›´è§‚çš„æ–¹å¼æ¥è®¿é—®å¤–éƒ¨å†…å­˜ã€‚</li>
</ul>
<h2 id="æ€§èƒ½è¡¨ç°">æ€§èƒ½è¡¨ç°</h2>
<ul>
<li>
<p><strong>è°ƒç”¨å¼€é”€</strong>ï¼šJNI æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå‘ç”Ÿ Java ä¸æœ¬åœ°ç¯å¢ƒä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé€šå¸¸å¼€é”€è¾ƒå¤§ã€‚FFM é€šè¿‡å‡å°‘å¿…è¦çš„è½¬æ¢æ­¥éª¤æ¥é™ä½å¼€é”€ï¼Œå¹¶åˆ©ç”¨åº•å±‚ä¼˜åŒ–ï¼ˆå¦‚ JIT inlineï¼‰æå‡æ•ˆç‡ã€‚</p>
</li>
<li>
<p><strong>å‘é‡ä¸å¹¶è¡Œ</strong>ï¼šFFM API ä¸æ–°ä¸€ä»£å‘é‡ API ç»“åˆç´§å¯†ï¼Œå¯ç›´æ¥æ”¯æŒ SIMD ç­‰ç¡¬ä»¶ç‰¹æ€§ï¼Œå®ç°é«˜æ€§èƒ½çš„å‘é‡è®¡ç®—ã€‚æ­¤å¤–ï¼ŒFFM å…è®¸ç”¨æˆ·è‡ªå®šä¹‰åˆ†é…å™¨å¹¶é‡å¤åˆ©ç”¨ <code>MemorySegment</code>ï¼Œä»¥è¿›ä¸€æ­¥å‡å°‘åˆ†é…å¼€é”€ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒJNI ä¸æ”¯æŒæ­¤ç±»ä¼˜åŒ–ï¼Œåªèƒ½ä¾èµ–æ‰‹å·¥ç®¡ç†çš„å†…å­˜åˆ†é…ã€‚</p>
</li>
<li>
<p><strong>æ•´ä½“æ€§èƒ½</strong>ï¼šæ€»ä½“è€Œè¨€ï¼ŒFFM æ—¨åœ¨â€œé€šè¿‡å‡å°‘å¼€é”€æ¥æå‡æ€§èƒ½â€ã€‚Oracle å¼€å‘è€…æŒ‡å‡ºï¼ŒFFM åœ¨å¾ˆå¤šåœºæ™¯ä¸‹æ€§èƒ½å·²è¾¾åˆ°æˆ–è¶…è¿‡ JNI æ°´å¹³ã€‚æ¯”å¦‚å€ŸåŠ© JIT ä¼˜åŒ–å’Œå‘é‡åŒ–ï¼ŒFFM ä¸‹çš„æœ¬åœ°è°ƒç”¨å¯ä»¥ä¸çº¯ C ä»£ç åª²ç¾ï¼Œè€Œ JNI ç”±äºå±‚å±‚å°è£…å¾€å¾€é€Ÿåº¦ç¨ä½ã€‚éšç€ JDK 22 çš„å‘å¸ƒï¼ŒFFM å¯¹å­—ç¬¦ä¸²ã€æ•°ç»„ç­‰è½¬æ¢è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼Œä½¿å…¶æ€§èƒ½æ˜¾è‘—ä¼˜äºä¼ ç»Ÿ JNIã€‚</p>
</li>
</ul>
<h2 id="å®‰å…¨æ€§">å®‰å…¨æ€§</h2>
<ul>
<li>
<p><strong>JNI å®‰å…¨é—®é¢˜</strong>ï¼šç”±äº JNI å…è®¸ç¼–å†™ä»»æ„ C/C++ ä»£ç ï¼Œå¼€å‘è€…å¿…é¡»è‡ªè¡Œå¤„ç†å†…å­˜ç®¡ç†å’Œç±»å‹è½¬æ¢ã€‚ä¼ ç»Ÿ JNI æ˜“å‡ºç°å†…å­˜æ³„æ¼ã€ç¼“å†²åŒºæº¢å‡ºã€ç©ºæŒ‡é’ˆè®¿é—®ç­‰é—®é¢˜ï¼Œä¸€æ—¦å¤„ç†ä¸å½“å°±å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒç”šè‡³å®‰å…¨æ¼æ´ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ <code>GetStringUTFChars</code> éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œ <code>NewGlobalRef</code> éœ€é¿å…æ³„æ¼ã€‚JNI æœ¬èº«å¯¹ Java å¯¹è±¡è®¿é—®ç¼ºä¹é™æ€æ£€æŸ¥ï¼Œå®¹æ˜“å‡ºé”™ã€‚</p>
</li>
<li>
<p><strong>FFM å®‰å…¨æœºåˆ¶</strong>ï¼šFFM API å¼•å…¥äº†å¤šé¡¹å†…ç½®å®‰å…¨æªæ–½ã€‚<code>MemorySegment</code> åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šè¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œé˜²æ­¢è¶Šç•Œè®¿é—®ï¼›<code>Arena</code> è‡ªåŠ¨ç®¡ç†æœ¬åœ°å†…å­˜ç”Ÿå‘½å‘¨æœŸï¼Œå‡ºä½œç”¨åŸŸå³é‡Šæ”¾ï¼Œå‡å°‘æ³„æ¼é£é™©ã€‚æ­¤å¤–ï¼ŒFFM çš„å‡½æ•°ç­¾åï¼ˆ<code>FunctionDescriptor</code>ï¼‰åœ¨ç¼–è¯‘æ—¶å¯æ£€æŸ¥å‚æ•°ç±»å‹å’Œæ•°é‡æ˜¯å¦åŒ¹é…ï¼Œé™ä½è°ƒç”¨é”™è¯¯ç‡ã€‚é˜¿é‡Œäº‘ç¤¾åŒºæŒ‡å‡ºï¼ŒFFM å¯¹ç±»å‹æ£€æŸ¥å’Œå†…å­˜ç®¡ç†è¿›è¡Œäº†å…¨é¢å‡çº§ï¼Œå¯ä»¥å‡å°‘ç±»å‹ä¸åŒ¹é…æˆ–å†…å­˜æ³„æ¼å¯¼è‡´çš„å´©æºƒå’Œå®‰å…¨é—®é¢˜ã€‚Java å›¢é˜Ÿä¹Ÿè¡¨ç¤ºï¼Œç›¸æ¯” JNI çš„â€œä¸å®‰å…¨â€æ–¹æ³•ï¼ŒFFM çš„ä¸å®‰å…¨æ“ä½œæ˜“äºä» Java ä»£ç ä¸­è°ƒç”¨ï¼Œå¹¶ä¸”é€šè¿‡æ›´å¤šé™åˆ¶ï¼ˆä¾‹å¦‚ JEP 472 å¯¹JNIä½¿ç”¨çš„é™åˆ¶ï¼‰æé«˜äº†æ•´ä½“å®‰å…¨æ€§ã€‚</p>
</li>
<li>
<p><strong>è®¿é—®æƒé™æ§åˆ¶</strong>ï¼šåœ¨æ›´é«˜ç‰ˆæœ¬çš„ JDK ä¸­ï¼ŒJava å¼€å§‹å¯¹æœ¬åœ°è®¿é—®æ–½åŠ ä¸¥æ ¼æ§åˆ¶ã€‚JEP 472 å³å»ºè®®åœ¨æœªæ¥å¯¹ JNI è°ƒç”¨å‘å‡ºè­¦å‘Šæˆ–é”™è¯¯ã€‚FFM API åŒæ ·å—é™äºâ€œæœ¬åœ°è®¿é—®â€ç­–ç•¥ï¼Œä½†ç”±äº FFM ä¸æ”¯æŒç›´æ¥è®¿é—® Java å¯¹è±¡ï¼ˆåªèƒ½æ“ä½œåŸç”Ÿæ•°æ®ï¼‰ï¼Œå¯¹ JVM å†…éƒ¨çŠ¶æ€å¹²æ‰°è¾ƒå°‘ã€‚å› æ­¤ï¼Œå¼€å‘è€…å¯ä»¥æ›´å®‰å…¨åœ°åœ¨ Java ä»£ç ä¸­ä½¿ç”¨ FFMï¼Œä»è€Œå‡å°‘äº§ç”Ÿ <code>--enable-native-access</code> ç­‰å®‰å…¨é£é™©ã€‚</p>
</li>
</ul>
<h2 id="å¯ç»´æŠ¤æ€§ä¸æ˜“ç”¨æ€§">å¯ç»´æŠ¤æ€§ä¸æ˜“ç”¨æ€§</h2>
<ul>
<li>
<p><strong>JNI çš„å¤æ‚æ€§</strong>ï¼šä¼ ç»Ÿ JNI ç¼–ç¨‹ç¹çï¼Œéœ€ç¼–å†™å¤§é‡æ ·æ¿ä»£ç ï¼šç”Ÿæˆå¤´æ–‡ä»¶ã€å®ç° <code>JNIEXPORT</code> å‡½æ•°ã€æ‰‹åŠ¨è½¬æ¢ç±»å‹ã€ç®¡ç†å¼•ç”¨ç­‰ã€‚è¿™äº›æ­¥éª¤å®¹æ˜“å‡ºé”™ï¼Œè°ƒè¯•ä¹Ÿéº»çƒ¦ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç®€å•çš„æœ¬åœ°è°ƒç”¨å°±è¦æ¶‰åŠ Java ç±»ã€C å¤´æ–‡ä»¶ã€C æºæ–‡ä»¶ã€ç¼–è¯‘è„šæœ¬ç­‰å¤šä¸ªç¯èŠ‚ã€‚ä»»ä½• Java ç±»åæˆ–æ–¹æ³•ç­¾åçš„å¾®å°å˜åŠ¨éƒ½å¯èƒ½å¯¼è‡´ JNI é“¾æ¥å¤±è´¥ã€‚</p>
</li>
<li>
<p><strong>FFM çš„ç®€æ´æ€§</strong>ï¼šFFM API è®¾è®¡ç®€æ´ï¼Œä½¿ç”¨çº¯ Java ä»£ç å³å¯å®Œæˆæœ¬åœ°è°ƒç”¨å’Œæ•°æ®è®¿é—®ã€‚æ˜ç¡®æŒ‡å‡ºï¼Œâ€œæ— éœ€ JNI Glue ä»£ç ï¼Œæ— éœ€æœ¬åœ°ç¼–è¯‘éº»çƒ¦ï¼Œåªéœ€çº¯ Java è°ƒç”¨æœ¬åœ°å‡½æ•°â€ã€‚Java å¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨ IDE ç¼–å†™ä»£ç ï¼Œæ— éœ€å¤–éƒ¨å·¥å…·ï¼ˆå¦‚ <code>javah</code>ï¼‰å’Œ C/C++ ç¼–è¯‘ç¯å¢ƒã€‚å¸¸ç”¨çš„æ•°æ®å¸ƒå±€å’Œç»“æ„ä½“å¯ç”¨ <code>MemoryLayout</code> ç®€å•æè¿°ï¼Œè®¿é—®å­—æ®µä½¿ç”¨ <code>VarHandle</code>ï¼Œé¿å…äº†æ‰‹åŠ¨è®¡ç®—åç§»é‡ã€‚Oracle ç§° FFM å¤§å¹…<strong>å‡å°‘æ ·æ¿ä»£ç </strong>å’Œæ‰€éœ€çš„åŸç”Ÿç¼–ç¨‹çŸ¥è¯†ï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚</p>
</li>
<li>
<p><strong>å·¥å…·æ”¯æŒ</strong>ï¼šFFM è¿˜é…å¥—äº† <code>jextract</code> å·¥å…·ï¼Œå¯ä»¥æ ¹æ® C å¤´æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ Java ç»‘å®šç±»ã€‚ä½¿ç”¨ <code>jextract</code>ï¼Œå¼€å‘è€…åªéœ€æŒ‡å‘ <code>.h</code> æ–‡ä»¶ï¼Œä¾¿å¯å¾—åˆ°å®Œæ•´çš„ Java æ¥å£å®šä¹‰ï¼Œè¿›ä¸€æ­¥å…é™¤äº†æ‰‹å†™åŒ…è£…ã€‚è¿™æ ·ï¼ŒFFM ä¸ä»…åœ¨è¯­è¨€å±‚é¢æ˜“ç”¨ï¼Œè¿˜æ‹¥æœ‰è‡ªåŠ¨åŒ–å·¥å…·ç”Ÿæ€ï¼Œå¤§å¹…é™ä½äº†ç»´æŠ¤æˆæœ¬ã€‚</p>
</li>
<li>
<p><strong>å†…å­˜ç®¡ç†ç®€åŒ–</strong>ï¼šJNI ä¸­çš„æœ¬åœ°å†…å­˜éœ€è¦æ˜¾å¼é‡Šæ”¾ï¼Œä¸å½“ä½¿ç”¨å®¹æ˜“å¼•å‘æ³„æ¼å’Œæ‚¬æŒ‚å¼•ç”¨ã€‚è€Œ FFM çš„ <code>Arena</code> åœ¨é€€å‡ºä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾åˆ†é…çš„ <code>MemorySegment</code>ã€‚è¿™ç§ try-with-resources çš„ä½¿ç”¨æ¨¡å¼ï¼Œå¤§å¤§ç®€åŒ–äº†å†…å­˜ç®¡ç†ã€‚Belief-driven-design åšå®¢ä¹Ÿæ€»ç»“ï¼šFFM æä¾›äº†æ›´ç®€å•ä¸”æ›´å®‰å…¨çš„å†…å­˜ç®¡ç†æŠ½è±¡ï¼Œå‡å°‘äº†å¯èƒ½çš„å†…å­˜æ³„æ¼ã€‚</p>
</li>
</ul>
<h2 id="è·¨å¹³å°å…¼å®¹æ€§">è·¨å¹³å°å…¼å®¹æ€§</h2>
<ul>
<li>
<p><strong>JNI çš„é™åˆ¶</strong>ï¼šè™½ç„¶ JNI è§„èŒƒæœ¬èº«è·¨å¹³å°ï¼Œä½†æ¯ç§æ“ä½œç³»ç»Ÿ/CPU æ¶æ„éƒ½éœ€è¦æä¾›ç¼–è¯‘åçš„æœ¬åœ°åº“ï¼ˆ.soã€.dll ç­‰ï¼‰ï¼Œå¹¶ç¡®ä¿æ­£ç¡®åŠ è½½ã€‚ä¸åŒå¹³å°å¯èƒ½å­˜åœ¨ ABI å·®å¼‚æˆ–å¯¹é½è§„åˆ™ä¸åŒï¼ŒJNI æ¥å£ä»£ç å¸¸å¸¸éœ€è¦é’ˆå¯¹å¹³å°è¿›è¡Œè°ƒæ•´ã€‚æ­£å› å¦‚æ­¤ï¼Œä»¥å‰çš„ Java ç‰ˆæœ¬å­˜åœ¨å¤šç§åŸç”Ÿæ¥å£è§„èŒƒï¼ˆå¦‚ Netscape JRIã€RNIï¼‰å¹¶å­˜çš„æƒ…å†µã€‚å³ä½¿ç°åœ¨å¤§å¤šæ•° JVM éµå¾ª JNIï¼Œå¼€å‘è€…ä»éœ€ä¸ºæ¯ä¸ªå¹³å°ç»´æŠ¤ç¼–è¯‘æµç¨‹ã€‚</p>
</li>
<li>
<p><strong>FFM çš„ä¼˜åŠ¿</strong>ï¼šFFM API é‡‡ç”¨æ ‡å‡†çš„ C ABIï¼ˆå¤šæ•°é€šè¿‡ libffi å®ç°ï¼‰ï¼Œå¹¶å†…ç½®å¯¹ Linuxã€macOSã€Windowsã€AIX ç­‰å¹³å°çš„æ”¯æŒã€‚åªè¦ç›®æ ‡å¹³å°æœ‰ç›¸åº”çš„ C åº“ï¼ŒJava ç¨‹åºå³å¯é€šè¿‡ FFM è°ƒç”¨ï¼Œæ— éœ€ä¿®æ”¹ Java ä»£ç æˆ–é‡æ–°ç”Ÿæˆ JNI æ¥å£ã€‚Belief-driven-design åšå®¢æŒ‡å‡ºï¼ŒFFM æœ‰â€œæ›´å¥½çš„å¯ç§»æ¤æ€§â€ï¼Œå› ä¸ºå®ƒä¸å†ä¾èµ–å¤æ‚è€Œè„†å¼±çš„ JNI æ ·æ¿ã€‚åœ¨å¯ç§»æ¤æ€§æ–¹é¢ï¼ŒFFM è®©è·¨å¹³å°å¼€å‘æ›´åŠ å¹³æ»‘ï¼šåªéœ€ä½¿ç”¨ç»Ÿä¸€çš„ Java APIï¼Œç”± JVM è´Ÿè´£é€‚é…åº•å±‚ ABIï¼Œä»è€Œé¿å…äº†ä¼ ç»Ÿ JNI åœ¨ä¸åŒç³»ç»Ÿé—´åå¤ç¼–è¯‘çš„éº»çƒ¦ã€‚</p>
</li>
</ul>
<h2 id="cc-ä»£ç å®ç°å·®å¼‚">C/C++ ä»£ç å®ç°å·®å¼‚</h2>
<ul>
<li>
<p><strong>JNI å®ç°</strong>ï¼šé‡‡ç”¨ JNI æ—¶ï¼ŒC/C++ ä¾§å¿…é¡»ä½¿ç”¨ JNI å¤´æ–‡ä»¶å¹¶æŒ‰ç…§å›ºå®šå‘½åè§„åˆ™ç¼–å†™æœ¬åœ°æ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒJava ç±» <code>com.example.Foo</code> ä¸­å£°æ˜äº† <code>public static native int bar(int x)</code>ï¼Œå¯¹åº”çš„ C å‡½æ•°ç­¾åå¿…é¡»ä¸º <code>Java_com_example_Foo_bar(JNIEnv *env, jclass cls, jint x)</code>ã€‚å‡½æ•°ä½“ä¸­é€šå¸¸é€šè¿‡ <code>env</code> è°ƒç”¨ APIï¼ˆå¦‚ <code>NewIntArray</code>ã€<code>SetByteArrayRegion</code> ç­‰ï¼‰å®ç°ä¸ Java ä¾§çš„æ•°æ®äº’è½¬ã€‚å¤æ‚ç»“æ„ä½“éœ€è¦åœ¨ Java ä¾§å†™ç›¸åº”çš„ JNI ä»£ç æ‰‹åŠ¨æ‹†åŒ…ã€‚æ¯æ–°å¢æˆ–ä¿®æ”¹ä¸€ä¸ª native æ–¹æ³•ï¼Œéƒ½éœ€è¦é‡æ–°ç”Ÿæˆå¤´æ–‡ä»¶ã€ç¼–è¯‘å¹¶éƒ¨ç½²æ–°çš„æœ¬åœ°åº“ã€‚</p>
</li>
<li>
<p><strong>FFM å®ç°</strong>ï¼šä½¿ç”¨ FFM æ—¶ï¼Œä¸€èˆ¬ä¸éœ€è¦ç¼–å†™ä»»ä½•æ–°çš„ C å‡½æ•°æ¥é€‚é… Javaã€‚Java ä»£ç å¯ä»¥ç›´æ¥ç»‘å®šç°æœ‰çš„ C åº“å‡½æ•°ï¼Œåªè¦è¿™äº›å‡½æ•°éµå¾ªå¸¸è§„ C ç­¾åå³å¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ C åº“ä¸­å·²æœ‰ <code>int add(int,int)</code>ï¼Œåªéœ€åœ¨ Java ç«¯è°ƒç”¨ <code>Linker.downcallHandle</code> ç»‘å®šå®ƒï¼Œæ— éœ€åœ¨ C ç«¯ä¸“é—¨å®ç°å¸¦ <code>JNIEnv*</code> çš„åŒ…è£…å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç°æœ‰çš„ C/C++ åº“å¾€å¾€å¯ä»¥åŸæ ·ä½¿ç”¨ï¼ŒFFM åªæ˜¯åœ¨ Java ä¾§åšè°ƒç”¨ã€‚å¯¹æ¯”è€Œè¨€ï¼ŒJNI è¦æ±‚ C ç«¯ä»¥ç‰¹æ®Šæ–¹å¼å¯¼å‡ºå‡½æ•°ï¼ˆä½¿ç”¨ <code>JNIEXPORT JNICALL</code> ç­‰ï¼‰ï¼Œè€Œ FFM æ²¡æœ‰æ­¤è¦æ±‚ã€‚</p>
</li>
<li>
<p><strong>æ•°æ®ç»“æ„å¤„ç†</strong>ï¼šåœ¨ JNI ä¸­ï¼ŒJava å¯¹è±¡å’Œæ•°ç»„éœ€è¦è½¬æ¢ä¸ºåŸç”Ÿç±»å‹ï¼ˆå¦‚ <code>jobject</code>, <code>jarray</code>ï¼‰ï¼Œä¸æ”¯æŒç›´æ¥è®¿é—® C ç»“æ„ä½“ã€‚FFM å…è®¸åœ¨ Java ç«¯ç”¨ <code>MemoryLayout.structLayout</code> æè¿° C ç»“æ„ä½“å¸ƒå±€ï¼Œç„¶åé€šè¿‡ <code>MemorySegment</code> è¿›è¡Œè¯»å†™ã€‚ä¸¾ä¾‹æ¥è¯´ï¼ŒC è¯­è¨€ä¸­çš„ <code>struct Point { int x; int y; }</code>ï¼Œåœ¨ FFM ä¸­å¯ç”¨ï¼š</p>
</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(){</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> point: </span><span style="color:#B392F0">MemoryLayout</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> MemoryLayout.</span><span style="color:#B392F0">structLayout</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        ValueLayout.JAVA_INT.</span><span style="color:#B392F0">withName</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"x"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">        ValueLayout.JAVA_INT.</span><span style="color:#B392F0">withName</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"y"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> xH </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> point.</span><span style="color:#B392F0">varHandle</span><span style="color:#E1E4E8">(PathElement.</span><span style="color:#B392F0">groupElement</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"x"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> yH </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> point.</span><span style="color:#B392F0">varHandle</span><span style="color:#E1E4E8">(PathElement.</span><span style="color:#B392F0">groupElement</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"y"</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">    Arena.</span><span style="color:#B392F0">ofConfined</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">use</span><span style="color:#E1E4E8"> { arena </span><span style="color:#F97583">-></span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> pt </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> arena.</span><span style="color:#B392F0">allocate</span><span style="color:#E1E4E8">(point)</span></span>
<span class="line"><span style="color:#E1E4E8">        xH.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(pt, </span><span style="color:#79B8FF">0L</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        yH.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(pt, </span><span style="color:#79B8FF">0L</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">20</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>è€Œåœ¨ JNI ä¸­ï¼Œå¤„ç†åŒæ ·ç»“æ„ä½“è¦ä¹ˆé€šè¿‡å­—èŠ‚ç¼“å†²åŒºæ‰‹åŠ¨æ‹¼å‡‘ï¼Œè¦ä¹ˆå†™å¾ˆå¤š <code>Get/Set</code> è°ƒç”¨ï¼Œè¿œä¸å¦‚ FFM ç®€æ´ç›´è§‚ã€‚</p>
<ul>
<li><strong>å›è°ƒï¼ˆUpcallï¼‰</strong>ï¼šç›®å‰ FFM API ä¸»è¦æ”¯æŒ Java è°ƒç”¨åŸç”Ÿå‡½æ•°ï¼ˆdowncallï¼‰ã€‚å¦‚æœéœ€è¦ä» C ä»£ç å›è°ƒ Java æ–¹æ³•ï¼ˆupcallï¼‰ï¼ŒJNI ç›®å‰è¿˜æ›´ä¸ºæˆç†Ÿï¼šJNI å¯åœ¨ native ä»£ç ä¸­é€šè¿‡ <code>(*env)->Call*Method</code> ç­‰ç›´æ¥è°ƒç”¨ Java ä»£ç ã€‚è€Œ FFM å¯¹è¿™ç±»å›è°ƒæš‚æ—¶æ”¯æŒæœ‰é™ï¼ˆéœ€ä½¿ç”¨ <code>Linker.upcallStub</code> ç”Ÿæˆå›è°ƒå‡½æ•°æŒ‡é’ˆï¼Œæµç¨‹è¾ƒå¤æ‚ï¼‰ã€‚å› æ­¤ï¼Œåœ¨éœ€è¦é¢‘ç¹ä»æœ¬åœ°ä»£ç è°ƒç”¨ Java çš„åœºæ™¯ï¼ˆå¦‚ Signal å¤„ç†ã€çº¿ç¨‹å›è°ƒï¼‰æ—¶ï¼ŒJNI ä»å…·ä¼˜åŠ¿ã€‚</li>
</ul>
<p>ç»¼ä¸Šï¼Œ<strong>FFM ä½¿å¾—å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ— éœ€ä¿®æ”¹ç°æœ‰ C ä»£ç </strong>â€”â€”åªè¦ C åº“å·²ç¼–è¯‘å¥½ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨ Java ä¾§è°ƒç”¨ï¼›è€Œ JNI åˆ™é€šå¸¸éœ€è¦ä¸ºæ¯ä¸ªæ–¹æ³•å†™ç‰¹å®šçš„ native å‡½æ•°ç­¾åã€‚è¿™ä¸€ç‚¹ä½¿å¾— FFM è¿ç§»æˆæœ¬è¾ƒä½ï¼šåªä¿®æ”¹ Java ç«¯è°ƒç”¨æ–¹å¼ï¼ŒC ç«¯å®ç°å¯ä»¥ä¸å˜ã€‚</p>
<h2 id="é€‚ç”¨åœºæ™¯">é€‚ç”¨åœºæ™¯</h2>
<ul>
<li>
<p><strong>ä½¿ç”¨ FFM API çš„æƒ…æ™¯</strong>ï¼š</p>
<ul>
<li><strong>æ–°å¼€å‘æˆ–è¿ç§»ç°æœ‰åº“</strong>ï¼šå¦‚æœéœ€è¦è°ƒç”¨å·²æœ‰çš„ C/C++ åº“ï¼ˆå¦‚ç³»ç»Ÿ APIã€ç¬¬ä¸‰æ–¹ç®—æ³•åº“ã€å›¾å½¢/AI æ¡†æ¶ç­‰ï¼‰ï¼ŒFFM æä¾›äº†æ›´å®‰å…¨ç®€æ´çš„è®¿é—®æ–¹å¼ã€‚å¯¹äºæ–°é¡¹ç›®ï¼Œæ¨èä¼˜å…ˆé‡‡ç”¨ FFM API è¿›è¡Œæœ¬åœ°äº’æ“ä½œã€‚Java æ–‡æ¡£ä¹Ÿå»ºè®®åœ¨é€‚ç”¨çš„æƒ…å†µä¸‹ä¼˜å…ˆä½¿ç”¨ FFM ä»¥å–ä»£ JNIã€‚</li>
<li><strong>é«˜æ€§èƒ½éœ€æ±‚</strong>ï¼šåœ¨éœ€è¦å……åˆ†å‘æŒ¥ç°ä»£ç¡¬ä»¶èƒ½åŠ›çš„åœºæ™¯ï¼ˆä¾‹å¦‚å¤§æ•°æ®å¤„ç†ã€å‘é‡è¿ç®—ã€è§†é¢‘/å›¾å½¢è®¡ç®—ï¼‰ï¼ŒFFM å¯ä»¥åˆ©ç”¨åº•å±‚ä¼˜åŒ–ï¼ˆå¦‚ SIMDã€å†…å­˜å¯¹é½ï¼‰è·å¾—æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½ã€‚</li>
<li><strong>å®‰å…¨ä¸å¿«é€Ÿè¿­ä»£</strong>ï¼šå¦‚æœé¡¹ç›®å¯¹ç¨³å®šæ€§å’Œå®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œéœ€è¦å‡å°‘ä½çº§å†…å­˜é”™è¯¯ï¼Œå¯é€‰ç”¨ FFM ä»¥è·å¾—è‡ªåŠ¨å†…å­˜ç®¡ç†å’Œç±»å‹å®‰å…¨çš„å¥½å¤„ã€‚åŒæ—¶ï¼Œç”±äºæ— éœ€ç¼–å†™ C ä»£ç ï¼Œå¯ä»¥ç”¨çº¯ Java å¿«é€Ÿè¿­ä»£ã€æœ¬åœ°éƒ¨ç½²æ›´æ–¹ä¾¿ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä½¿ç”¨ JNI çš„æƒ…æ™¯</strong>ï¼š</p>
<ul>
<li><strong>é—ç•™ç³»ç»Ÿæˆ–ç‰¹æ®Šéœ€æ±‚</strong>ï¼šå¦‚æœå·²æœ‰å¤§é‡ JNI ä»£ç ã€æˆ–è€…éœ€è¦ä½¿ç”¨ä¸€äº› FFM ç›®å‰ä¸æ”¯æŒçš„åŠŸèƒ½ï¼ˆå¦‚ç›´æ¥æ“ä½œ Java å¯¹è±¡ã€åˆ©ç”¨ JNI æ³¨å†Œå›è°ƒ Java æ–¹æ³•ã€è°ƒç”¨æŸäº›åªæä¾› JNI æ¥å£çš„åº“ï¼‰ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ JNIã€‚å¯¹äºç°æœ‰çš„ JNI åº“ï¼Œå¯ä»¥é€æ­¥è¯„ä¼°è¿ç§»æˆæœ¬ï¼›æœ‰æ—¶ç›´æ¥è°ƒç”¨ JNI æ›´å¿«æ·ã€‚</li>
<li><strong>Java åµŒå…¥åœºæ™¯</strong>ï¼šåœ¨ä½¿ç”¨ JNI è°ƒç”¨ Java è™šæ‹Ÿæœºï¼ˆJNI Invocation APIï¼‰å°† JVM åµŒå…¥åˆ°æœ¬åœ°åº”ç”¨ä¸­æ—¶ï¼Œéœ€è¦ä¾èµ– JNI æ¥å£ã€‚æåˆ° JNI åœ¨è¿™ç§åµŒå…¥å¼ä½¿ç”¨ä¸‹çš„ä¼˜åŠ¿ã€‚</li>
<li><strong>æç«¯æ€§èƒ½è°ƒä¼˜</strong>ï¼šè™½ç„¶ FFM åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸­æ€§èƒ½å·²ç»ä¼˜ç§€ï¼Œä½†åœ¨æç«¯è‹›åˆ»çš„ä½å»¶è¿Ÿåœºåˆï¼Œç»éªŒä¸°å¯Œçš„ C/C++ å¼€å‘è€…å¯èƒ½ä»ä¼šé€‰æ‹©æ‰‹åŠ¨ä¼˜åŒ– JNI è°ƒç”¨è·¯å¾„ï¼ˆå¦‚ç¼“å­˜ <code>JNIEnv*</code> æŒ‡é’ˆã€æœ€å°åŒ– JNI è°ƒç”¨å¼€é”€ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼Œå¯¹äºå¤§å¤šæ•°æ–°é¡¹ç›®å’Œå¸¸è§ç”¨é€”ï¼ˆ<strong>è°ƒç”¨æœ¬åœ°åº“ã€å¤„ç†æœ¬åœ°æ•°æ®</strong>ï¼‰ï¼ŒFFM API æ˜¯æ›´ä¼˜çš„é€‰æ‹©ï¼›è€Œ JNI ä¸»è¦é€‚ç”¨äºä¼ ç»Ÿ/ç‰¹æ®Šåœºæ™¯æˆ–è¿‡æ¸¡é˜¶æ®µã€‚éšç€ JDK 23 åŠä»¥åç‰ˆæœ¬å¯¹ JNI çš„ä½¿ç”¨è¶Šæ¥è¶Šå¤šé™åˆ¶ï¼ˆä¾‹å¦‚é»˜è®¤å¯¹ JNI è°ƒç”¨å‘å‡ºè­¦å‘Šæˆ–æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼ŒJava å¹³å°æ­£é€æ­¥é¼“åŠ±ä½¿ç”¨ FFM APIã€‚å› æ­¤ï¼Œå¼€å‘è€…åº”åœ¨æ–°åŠŸèƒ½å¼€å‘æ—¶ä¼˜å…ˆè€ƒè™‘ FFMï¼Œåœ¨å¿…é¡»æ—¶æ‰ä½¿ç”¨ JNIï¼Œä»¥ä¿æŒä»£ç ç°ä»£æ€§å’Œå®‰å…¨æ€§ã€‚</p>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin/">Kotlin</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/FFM API/">FFM API</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/JNI/">JNI</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/è·¨è¯­è¨€äº’æ“ä½œ/">è·¨è¯­è¨€äº’æ“ä½œ</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/æ€§èƒ½ä¼˜åŒ–/">æ€§èƒ½ä¼˜åŒ–</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/å†…å­˜ç®¡ç†/">å†…å­˜ç®¡ç†</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/ç³»ç»Ÿç¼–ç¨‹/">ç³»ç»Ÿç¼–ç¨‹</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">ğŸ“«</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div> <script type="module" is:global>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach((block) => {
                const button = document.createElement('button')
                button.innerText = 'å¤åˆ¶'
                button.className =
                    'absolute top-2 right-2 bg-slate-800 text-white px-2 py-1 rounded text-sm opacity-50 hover:opacity-100 transition cursor-pointer'
                button.addEventListener('click', () => {
                    const code = block.querySelector('code')
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerText = 'å·²å¤åˆ¶ï¼'
                            setTimeout(() => (button.innerText = 'å¤åˆ¶'), 1000)
                        })
                    }
                })
                block.classList.add('relative')
                block.appendChild(button)
            })
        })
    </script>  </body></html>