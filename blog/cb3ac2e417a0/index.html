<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="-RgOsAO7rMTpJ8vNk8-ILdAA8VmiTEUc9HiUVVTKeEs"><meta name="generator" content="Astro v5.15.6"><title>âœ¨å¾¡å‚ç½‘ç»œ-Java VarHandle ä¸ Reflection çš„å¯¹æ¯”åŠæ€§èƒ½æµ‹è¯•âœ¨</title><link rel="stylesheet" href="/_astro/index.CVE_tfyK.css">
<style>/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid}}}.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%;position:relative}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88047 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% -.0000298023 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-border-style:solid;--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0}}}.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s));transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.BkXjpIp6.css"><script type="module" src="/_astro/page.D1uwR3nK.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/" class="q0UmqG_navLink">home</a> <a href="/blog/" class="q0UmqG_navLink">blog</a> <a href="/utils/" class="q0UmqG_navLink">utils</a> <a href="/dream-map/" class="inline-block">dream map</a> <a href="/album/" class="q0UmqG_navLink">album</a> <a href="/about-me/" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px] overflow-auto"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">ä½œè€…ï¼šmisakamayako</p>  <p class="text-white text-center mt-2">å‘å¸ƒæ—¶é—´ï¼š2024/08/26</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">ç®€ä»‹</h3> <p class="text-white font-light mb-2">æœ¬æ–‡è¯¦ç»†æ¯”è¾ƒäº†Java 9å¼•å…¥çš„VarHandleä¸ä¼ ç»Ÿåå°„æœºåˆ¶åœ¨æ€§èƒ½ã€ç±»å‹å®‰å…¨ã€çº¿ç¨‹å®‰å…¨åŠé€‚ç”¨åœºæ™¯ä¸Šçš„å·®å¼‚ï¼Œé™„å¸¦ä»£ç ç¤ºä¾‹å’Œå¤šçº¿ç¨‹æ€§èƒ½æµ‹è¯•ï¼Œå¸®åŠ©å¼€å‘è€…é€‰æ‹©åˆé€‚çš„å­—æ®µè®¿é—®æ–¹å¼ã€‚</p> </div> <!-- 2. æ–‡ç« ç›®å½• --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">æœ¬æ–‡ç›®å½•</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. éšæœºæ–‡ç«  --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">éšä¾¿çœ‹çœ‹</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/2ed8a0ceb014/"> WebGPU vs CPUï¼šå¹¶è¡Œè®¡ç®—æ€§èƒ½å®æµ‹å¯¹æ¯” </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/88fe8af400de/"> JDK 22 FFM API ä¸ä¼ ç»Ÿ JNI çš„å¯¹æ¯” </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/31aca58e217e/"> Javaæ€§èƒ½è°ƒä¼˜ï¼šä¸ºä½•VarHandleæ˜¯å–ä»£åå°„çš„â€œé“¶å¼¹â€ï¼Ÿ </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-zinc-200 mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-current prose-strong:text-current prose-code:text-current
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>Java VarHandle ä¸ Reflection çš„å¯¹æ¯”åŠæ€§èƒ½æµ‹è¯•</h1> </header> <p>å˜é‡å¥æŸ„ï¼ˆVarHandleï¼‰å’Œåå°„ï¼ˆReflectionï¼‰éƒ½æ˜¯Javaä¸­å¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºæ“ä½œç±»çš„å±æ€§ã€æ–¹æ³•å’Œå†…å­˜ç»“æ„ã€‚å®ƒä»¬å„è‡ªæœ‰ä¸åŒçš„è®¾è®¡ç›®æ ‡å’Œé€‚ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯å¯¹VarHandleå’Œåå°„çš„æ¯”è¾ƒï¼š</p>
<h2 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h2>
<ul>
<li><strong>VarHandle</strong>: å¼•å…¥äºJava 9ï¼Œå®ƒæä¾›äº†ä¸€ç§ç±»ä¼¼äºåå°„çš„æœºåˆ¶ï¼Œç”¨äºè®¿é—®å’Œä¿®æ”¹å­—æ®µï¼Œä½†æ¯”åå°„æ›´é«˜æ•ˆã€‚VarHandleä¸“æ³¨äºç›´æ¥å†…å­˜è®¿é—®æ“ä½œï¼Œç‰¹åˆ«æ˜¯é‚£äº›æ¶‰åŠå¤šçº¿ç¨‹å’Œå¹¶å‘ç¼–ç¨‹çš„åœºæ™¯ã€‚</li>
<li><strong>åå°„</strong>: åå°„å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è®¿é—®å’Œä¿®æ”¹ç±»çš„å±æ€§å’Œæ–¹æ³•ã€‚å®ƒå¯ä»¥ç”¨æ¥å®ç°æ¡†æ¶ã€åº“å’Œå·¥å…·ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿåœ¨ä¸äº‹å…ˆäº†è§£ç±»å‹çš„æƒ…å†µä¸‹æ“ä½œå¯¹è±¡ã€‚</li>
</ul>
<h2 id="2-æ€§èƒ½">2. æ€§èƒ½</h2>
<ul>
<li><strong>VarHandle</strong>: VarHandleçš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€æ˜¯æ€§èƒ½ã€‚å®ƒé€šè¿‡åº•å±‚æœºåˆ¶ï¼Œå¦‚Unsafeç±»å’Œå†…å­˜å±éšœï¼Œæä¾›æ¯”åå°„æ›´ç›´æ¥çš„å†…å­˜è®¿é—®ï¼Œå› æ­¤åœ¨å¤„ç†é¢‘ç¹çš„å­—æ®µè®¿é—®æ—¶ï¼ŒVarHandleè¡¨ç°å‡ºæ›´é«˜çš„æ•ˆç‡ã€‚</li>
<li><strong>åå°„</strong>: åå°„çš„æ€§èƒ½è¾ƒä½ï¼Œå› ä¸ºå®ƒæ¶‰åŠè¾ƒå¤šçš„åŠ¨æ€ç±»å‹æ£€æŸ¥å’Œå®‰å…¨æ£€æŸ¥ã€‚è™½ç„¶Javaåœ¨JVMä¸­å¯¹åå°„åšäº†ä¼˜åŒ–ï¼Œä½†åå°„åœ¨é«˜é¢‘ç‡æ“ä½œä¸­çš„å¼€é”€ä»ç„¶è¾ƒå¤§ã€‚</li>
</ul>
<p>ä¸‹é¢ä»¥ä¸€ç™¾ä¸‡æ¬¡å¯¹åŒä¸€ä¸ªå­—æ®µè¿›è¡Œè®¾ç½®å’Œå–å€¼è¿›è¡Œæ¯”è¾ƒ</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> Person</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">    @JvmField</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> name:</span><span style="color:#B392F0">String</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(){</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> person </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Person</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"a"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#F97583"> field</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">Field</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Person::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java.</span><span style="color:#B392F0">getDeclaredField</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> reflectionStart </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#B392F0">    repeat</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1_000_000</span><span style="color:#E1E4E8">){</span></span>
<span class="line"><span style="color:#F97583">        field</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(person, </span><span style="color:#9ECBFF">"name2"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> newName </span><span style="color:#F97583">=</span><span style="color:#F97583"> field</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(person)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> reflectionEnd </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"reflection use time: ${reflectionEnd </span><span style="color:#F97583">-</span><span style="color:#9ECBFF">reflectionStart}"</span><span style="color:#E1E4E8"> )</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> lookup </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MethodHandles.</span><span style="color:#B392F0">lookup</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> varHandle: </span><span style="color:#B392F0">VarHandle</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> lookup.</span><span style="color:#B392F0">findVarHandle</span><span style="color:#E1E4E8">(Person::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java, </span><span style="color:#9ECBFF">"name"</span><span style="color:#E1E4E8">, String::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java)</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> varHandleStart </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#B392F0">    repeat</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1_000_000</span><span style="color:#E1E4E8">){</span></span>
<span class="line"><span style="color:#E1E4E8">        varHandle.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(person, </span><span style="color:#9ECBFF">"name3"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> newName </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> varHandle.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(person)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> varHandleEnd </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"varHandle  use time: ${varHandleEnd</span><span style="color:#F97583">-</span><span style="color:#9ECBFF">varHandleStart}"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>è¿è¡Œåæ§åˆ¶å°è¾“å‡º</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>reflection use time: 560190800</span></span>
<span class="line"><span>varHandle  use time: 144712700</span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒvarHandleçš„è¿è¡Œé€Ÿåº¦æ˜¾è‘—çš„å¿«äºä½¿ç”¨åå°„ï¼ŒèŠ‚çœäº†æ¥è¿‘75%çš„æ—¶é—´ï¼ˆå…·ä½“çš„èŠ‚çœæ¯”ä¾‹å–å†³äºè¿è¡Œç¯å¢ƒï¼Œä½†æ˜¯æ˜¾è‘—å‡å°‘æ—¶é—´æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼‰</p>
<h2 id="3-ç±»å‹å®‰å…¨">3. ç±»å‹å®‰å…¨</h2>
<ul>
<li><strong>VarHandle</strong>: VarHandleæä¾›äº†ä¸€å®šçš„ç±»å‹å®‰å…¨æ€§ã€‚å®ƒåœ¨å®šä¹‰æ—¶å°±ç¡®å®šäº†å¯ä»¥æ“ä½œçš„å­—æ®µçš„ç±»å‹ï¼Œå› æ­¤åœ¨æ—©æœŸå°±å¯ä»¥è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå‡å°‘äº†è¿è¡Œæ—¶é”™è¯¯çš„å¯èƒ½æ€§ã€‚</li>
<li><strong>åå°„</strong>: åå°„æ˜¯åŠ¨æ€çš„ï¼Œç±»å‹æ£€æŸ¥æ˜¯åœ¨è¿è¡Œæ—¶è¿›è¡Œçš„ï¼Œè¿™æ„å‘³ç€ç¼–è¯‘å™¨æ— æ³•æ•è·æŸäº›ç±»å‹é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆå¦‚<code>IllegalArgumentException</code>æˆ–<code>ClassCastException</code>ï¼‰ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯åœ¨IntelliJ IDEA 2024.2 (Ultimate Edition)ä¸­ç¼–å†™ä»£ç æ—¶ï¼Œideaçš„æç¤º
<img alt="varhandleç±»å‹å®‰å…¨.png" loading="lazy" decoding="async" fetchpriority="auto" width="679" height="221" src="/_astro/varhandle%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8.BajXtIc4_1aM7z0.webp" ></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä½¿ç”¨varHandleæ—¶ï¼Œideaæ­£ç¡®çš„è¯†åˆ«å‡ºæ¥ç±»å‹å¹¶ç»™äºˆæç¤ºï¼Œä½†æ˜¯ä½¿ç”¨åå°„å°±æ²¡æœ‰ã€‚</p>
<h2 id="4-çº¿ç¨‹å®‰å…¨">4. çº¿ç¨‹å®‰å…¨</h2>
<ul>
<li><strong>VarHandle</strong>: æä¾›äº†å†…ç½®çš„çº¿ç¨‹å®‰å…¨ä¿éšœï¼Œé€šè¿‡ VarHandle çš„æ–¹æ³•ï¼ˆå¦‚ getAcquireã€setReleaseï¼‰è®¾ç½®å±éšœï¼Œè¿›è¡Œå®‰å…¨çš„åŸå­æ“ä½œï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ­£ç¡®æ€§ã€‚è¿™äº›æ“ä½œå¯ä»¥é˜²æ­¢æ•°æ®ç«äº‰å’Œä¿è¯å†…å­˜å¯è§æ€§ã€‚</li>
<li><strong>åå°„</strong>: åå°„æ“ä½œæœ¬èº«æ²¡æœ‰çº¿ç¨‹å®‰å…¨çš„ä¿éšœã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨åå°„æ¥è®¿é—®æˆ–ä¿®æ”¹åŒä¸€å­—æ®µï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´æ€§ã€‚å¿…é¡»é€šè¿‡æ˜¾å¼çš„åŒæ­¥ï¼ˆå¦‚ä½¿ç”¨ synchronized å…³é”®å­—æˆ–å…¶ä»–å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼‰æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼ŒåŒæ—¶è·å–å’Œé‡Šæ”¾é”ä¹Ÿä¼šå¯¼è‡´é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨å¤šçº¿ç¨‹ä¸­æ“ä½œæ•°æ®çš„ä¸€ä¸ªå¯¹æ¯”</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> java.lang.invoke.MethodHandles</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> java.lang.invoke.VarHandle</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#B392F0"> java.lang.reflect.Field</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> VarHandleCounter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    @Volatile</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> count </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    companion</span><span style="color:#F97583"> object</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        // ä½¿ç”¨VarHandleè®¿é—®countå­—æ®µ</span></span>
<span class="line"><span style="color:#F97583">        private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> handler: </span><span style="color:#B392F0">VarHandle</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#E1E4E8">            MethodHandles.</span><span style="color:#B392F0">lookup</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">findVarHandle</span><span style="color:#E1E4E8">(VarHandleCounter::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java, </span><span style="color:#9ECBFF">"count"</span><span style="color:#E1E4E8">, Int::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.javaPrimitiveType)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fun</span><span style="color:#B392F0"> increment</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">        handler.</span><span style="color:#B392F0">getAndAdd</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fun</span><span style="color:#B392F0"> get</span><span style="color:#E1E4E8">(): </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> handler.</span><span style="color:#B392F0">getVolatile</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> Int</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> ReflectionCounter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    @Volatile</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> var</span><span style="color:#E1E4E8"> count </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    companion</span><span style="color:#F97583"> object</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> counter: </span><span style="color:#B392F0">Field</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> ReflectionCounter::</span><span style="color:#B392F0">class</span><span style="color:#E1E4E8">.java.</span><span style="color:#B392F0">getDeclaredField</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"count"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            isAccessible </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    @Synchronized</span></span>
<span class="line"><span style="color:#F97583">    fun</span><span style="color:#B392F0"> increment</span><span style="color:#E1E4E8">(): </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> counter.</span><span style="color:#B392F0">getInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> newValue </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> current </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">        counter.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, newValue)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> newValue</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fun</span><span style="color:#B392F0"> get</span><span style="color:#E1E4E8">(): </span><span style="color:#B392F0">Int</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> counter.</span><span style="color:#B392F0">getInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> countTime</span><span style="color:#E1E4E8">(function: () </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> Unit): </span><span style="color:#B392F0">Float</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> start </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#B392F0">    function</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> end </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> System.</span><span style="color:#B392F0">nanoTime</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"time used:${end </span><span style="color:#F97583">-</span><span style="color:#9ECBFF"> start}"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> (end </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> start).</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fun</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> varHandleCounter </span><span style="color:#F97583">=</span><span style="color:#B392F0"> VarHandleCounter</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> reflectionCounter </span><span style="color:#F97583">=</span><span style="color:#B392F0"> ReflectionCounter</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> threads </span><span style="color:#F97583">=</span><span style="color:#B392F0"> List</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        Thread</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            repeat</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                reflectionCounter.</span><span style="color:#B392F0">increment</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> threads2 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> List</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        Thread</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            repeat</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                varHandleCounter.</span><span style="color:#B392F0">increment</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> time1 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> countTime</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        threads.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(Thread::</span><span style="color:#B392F0">start</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        threads.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(Thread::</span><span style="color:#B392F0">join</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">        println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Final count using Reflection: ${reflectionCounter.</span><span style="color:#B392F0">get</span><span style="color:#9ECBFF">()}"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    val</span><span style="color:#E1E4E8"> time2 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> countTime</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        threads2.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(Thread::</span><span style="color:#B392F0">start</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        threads2.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(Thread::</span><span style="color:#B392F0">join</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">        println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Final count using VarHandle: ${varHandleCounter.</span><span style="color:#B392F0">get</span><span style="color:#9ECBFF">()}"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    println</span><span style="color:#E1E4E8">(String.</span><span style="color:#B392F0">format</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"time reduce for %.2f%%"</span><span style="color:#E1E4E8">, (</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> -</span><span style="color:#E1E4E8"> (time2 </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> time1)) </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img alt="varhandleè¿è¡Œæ—¶é—´æ¯”è¾ƒ.png" loading="lazy" decoding="async" fetchpriority="auto" width="378" height="210" src="/_astro/varhandle%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4%E6%AF%94%E8%BE%83.B1LA7rNv_Kx0ma.webp" ></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç”±äºåå°„æ²¡æœ‰å¤©ç„¶çš„çº¿ç¨‹å®‰å…¨ä¿éšœï¼Œåœ¨å¤šçº¿ç¨‹ä½¿ç”¨æ—¶å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´ï¼Œå¿…é¡»é€šè¿‡æ˜¾ç¤ºçš„åŒæ­¥æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿™å¸¦æ¥äº†é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚
è€Œ<code>varHandle</code>æä¾›äº†é«˜æ•ˆçš„åŸå­æ“ä½œï¼Œåˆ©ç”¨åº•å±‚æœºåˆ¶ï¼ˆå¦‚å†…å­˜å±éšœï¼‰æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä»–åœ¨å¤„ç†å¤§é‡å¹¶å‘æ—¶ï¼Œæ€§èƒ½æ˜¯æ˜¾è‘—ä¼˜äºåå°„çš„ã€‚åœ¨æˆ‘ä½¿ç”¨çš„è¿™å°ç”µè„‘ä¸Šï¼Œè¿è¡Œæ—¶é—´å‡å°‘äº†88%</p>
<h2 id="5-é€‚ç”¨åœºæ™¯">5. é€‚ç”¨åœºæ™¯</h2>
<ul>
<li><strong>VarHandle</strong>: ä¸»è¦ç”¨äºå¹¶å‘ç¼–ç¨‹ä¸­ï¼Œä¾‹å¦‚åŸå­æ“ä½œã€é”å’Œå†…å­˜å±éšœã€‚å®ƒè¿˜å¯ä»¥æ›¿ä»£ä¸€äº›Unsafeç±»çš„ç”¨æ³•ï¼Œä½¿ä»£ç æ›´åŠ å®‰å…¨å’Œå¯ç»´æŠ¤ã€‚</li>
<li><strong>åå°„</strong>: å¹¿æ³›ç”¨äºæ¡†æ¶è®¾è®¡ã€ä¾èµ–æ³¨å…¥ã€åºåˆ—åŒ–/ååºåˆ—åŒ–ç­‰éœ€è¦åŠ¨æ€ç±»å‹ä¿¡æ¯çš„åœºæ™¯ã€‚åå°„åœ¨å¼€å‘ä¸­æœ‰éå¸¸å¹¿æ³›çš„åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨é‚£äº›éœ€è¦å¤„ç†æœªçŸ¥ç±»å‹çš„åœºæ™¯ä¸­ã€‚</li>
</ul>
<h2 id="6-æ˜“ç”¨æ€§">6. æ˜“ç”¨æ€§</h2>
<ul>
<li><strong>VarHandle</strong>: è™½ç„¶æä¾›äº†æ›´é«˜æ•ˆçš„å†…å­˜è®¿é—®ï¼Œä½†ä½¿ç”¨VarHandleæ¯”åå°„æ›´å¤æ‚ã€‚å®ƒéœ€è¦æ›´æ·±çš„ç†è§£å¹¶å‘ç¼–ç¨‹å’Œå†…å­˜æ¨¡å‹ï¼Œä»£ç ä¹Ÿæ›´éš¾ä»¥é˜…è¯»ã€‚</li>
<li><strong>åå°„</strong>: ç›¸å¯¹æ¥è¯´ï¼Œåå°„æ›´å®¹æ˜“ç†è§£å’Œä½¿ç”¨ã€‚å®ƒçš„APIæ›´åŠ å‹å¥½ï¼Œæ–‡æ¡£ä¸°å¯Œï¼Œå¼€å‘è€…æ›´å®¹æ˜“ä¸Šæ‰‹ã€‚</li>
</ul>
<h2 id="7-ä»£ç å®‰å…¨æ€§">7. ä»£ç å®‰å…¨æ€§</h2>
<ul>
<li><strong>VarHandle</strong>: VarHandleæ›´å®‰å…¨ï¼Œå› ä¸ºå®ƒåœ¨è®¾è®¡ä¸Šè§„é¿äº†ä¸€äº›Unsafeç±»çš„æ½œåœ¨é£é™©ï¼Œå¹¶ä¸”åœ¨è®¿é—®æƒé™æ–¹é¢è¿›è¡Œäº†æ›´ä¸¥æ ¼çš„æ§åˆ¶ã€‚</li>
<li><strong>åå°„</strong>: åå°„å­˜åœ¨ä¸€å®šçš„å®‰å…¨éšæ‚£ï¼Œå› ä¸ºå®ƒå¯ä»¥ç»•è¿‡è®¿é—®æ§åˆ¶ï¼Œæ“ä½œç§æœ‰æˆå‘˜ã€‚è¿™ä½¿å¾—åå°„æœ‰æ—¶ä¼šè¢«ç”¨äºæ”»å‡»æˆ–è€…å¯¼è‡´ä¸å®‰å…¨çš„ä»£ç ã€‚</li>
</ul>
<h2 id="ç»“è®º">ç»“è®º</h2>
<p>VarHandleå’Œåå°„å„æœ‰ä¼˜åŠ£ï¼Œé€‰æ‹©å“ªä¸ªå–å†³äºå…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚å¦‚æœä½ éœ€è¦é«˜æ•ˆã€å®‰å…¨çš„å­—æ®µæ“ä½œï¼Œç‰¹åˆ«æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼ŒVarHandleæ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼›è€Œå¦‚æœä½ éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€å¤„ç†ç±»çš„ç»“æ„ï¼Œåå°„åˆ™æ˜¯æ›´é€‚åˆçš„å·¥å…·ã€‚æ€»çš„æ¥è¯´ï¼ŒVarHandleé€‚åˆé‚£äº›éœ€è¦ä¼˜åŒ–æ€§èƒ½å¹¶ç¡®ä¿ç±»å‹å®‰å…¨çš„åœºæ™¯ï¼Œè€Œåå°„åˆ™é€‚åˆçµæ´»æ€§å’ŒåŠ¨æ€æ€§è¦æ±‚æ›´é«˜çš„åœºæ™¯ã€‚</p>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/Kotlin/">Kotlin</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/VarHandle/">VarHandle</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/åå°„/">åå°„</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/çº¿ç¨‹å®‰å…¨/">çº¿ç¨‹å®‰å…¨</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/JVM/">JVM</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/å¤šçº¿ç¨‹/">å¤šçº¿ç¨‹</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">ğŸ“«</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div> <script type="module" is:global>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach((block) => {
                const button = document.createElement('button')
                button.innerText = 'å¤åˆ¶'
                button.className =
                    'absolute top-2 right-2 bg-slate-800 text-white px-2 py-1 rounded text-sm opacity-50 hover:opacity-100 transition cursor-pointer'
                button.addEventListener('click', () => {
                    const code = block.querySelector('code')
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerText = 'å·²å¤åˆ¶ï¼'
                            setTimeout(() => (button.innerText = 'å¤åˆ¶'), 1000)
                        })
                    }
                })
                block.classList.add('relative')
                block.appendChild(button)
            })
        })
    </script>  </body></html>