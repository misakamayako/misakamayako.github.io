<!DOCTYPE html><html lang="zh-hans" class="h-full w-full m-0"> <head><meta charset="utf-8"><link rel="icon" type="image/jepg" href="/favicon.jpg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.9.1"><title>âœ¨å¾¡å‚ç½‘ç»œ-æµè§ˆå™¨ç«¯å¼‚æ­¥æµæ•°æ®èµ„æºç®¡ç†âœ¨</title><link rel="stylesheet" href="/_astro/index.jpoqI2TY.css">
<style>/*! tailwindcss v4.0.9 | MIT License | https://tailwindcss.com */
.okTgGW_footer{font-size:var(--text-sm,.875rem);line-height:var(--tw-leading,var(--text-sm--line-height,calc(1.25/.875)));color:var(--color-stone-400,#a6a09b);text-align:center;padding-block:calc(var(--spacing,.25rem)*4);border-top-color:var(--color-zinc-50,#fafafa);border-top-style:var(--tw-border-style);background-color:var(--color-slate-900,#0f172b);border-top-width:2px;width:100%}@supports (color:color(display-p3 0 0 0)){.okTgGW_footer{color:var(--color-stone-400,color(display-p3 .647628 .627105 .61098));border-top-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256));background-color:var(--color-slate-900,color(display-p3 .0639692 .0891152 .163036))}}@supports (color:lab(0% 0 0)){.okTgGW_footer{color:var(--color-stone-400,lab(66.2166% 1.88047 3.20326));border-top-color:var(--color-zinc-50,lab(98.26% -.0000298023 0));background-color:var(--color-slate-900,lab(7.78673% 1.82345 -15.0537))}}.okTgGW_footer a{text-decoration-line:underline}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}
/*! tailwindcss v4.0.9 | MIT License | https://tailwindcss.com */
.q0UmqG_menu{height:calc(var(--spacing,.25rem)*16);padding-right:calc(var(--spacing,.25rem)*16);border-bottom-color:var(--color-zinc-50,#fafafa);border-bottom-style:var(--tw-border-style);text-align:right;border-bottom-width:2px}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu{border-bottom-color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}.q0UmqG_menu a{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_menu a:hover{--tw-translate-y:calc(var(--spacing,.25rem)*-.5);translate:var(--tw-translate-x)var(--tw-translate-y);color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_menu a:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_menu a{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s));transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function,cubic-bezier(.4,0,.2,1)));transition-duration:var(--tw-duration,var(--default-transition-duration,.15s))}.q0UmqG_navLink{padding-inline:calc(var(--spacing,.25rem)*2);padding-block:calc(var(--spacing,.25rem)*2);font-size:var(--text-xl,1.25rem);line-height:var(--tw-leading,var(--text-xl--line-height,calc(1.75/1.25)));color:var(--color-zinc-50,#fafafa);margin-top:calc(var(--spacing,.25rem)*2.5);display:inline-block}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,color(display-p3 .980256 .980256 .980256))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink{color:var(--color-zinc-50,lab(98.26% -.0000298023 0))}}@media (hover:hover){.q0UmqG_navLink:hover{color:var(--color-sky-500,#00a5ef)}@supports (color:color(display-p3 0 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,color(display-p3 .219113 .639027 .931479))}}@supports (color:lab(0% 0 0)){.q0UmqG_navLink:hover{color:var(--color-sky-500,lab(63.3038% -18.433 -51.0407))}}}.q0UmqG_navLink{transition:color .4s}.q0UmqG_avatar{float:right;border-radius:.25rem;display:inline-block;overflow:hidden}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}
</style>
<link rel="stylesheet" href="/_astro/_slug_.D5CD64Zi.css"><script type="module" src="/_astro/page.V2R8AmkL.js"></script></head> <body class="w-full h-full flex flex-col">  <div class="bg-slate-800 h-screen flex flex-col"> <div class="bg-slate-700 w-full"> <div class="q0UmqG_avatar"> <img src="/favicon.jpg" width="64" height="64" alt=""> </div> <nav class="q0UmqG_menu"> <a href="/blog" class="q0UmqG_navLink">blog</a> <a href="/dream-map" class="inline-block">dream map</a> <a href="/album" class="q0UmqG_navLink">album</a> <a href="/about-me" class="q0UmqG_navLink">about me</a> </nav> </div> <div class="flex p-4 grow flex-row h-full overflow-hidden"> <aside class="w-1/4 ml-4 md:block min-w-[200px]"> <div class="sticky top-4 space-y-6"> <div class="bg-slate-700 p-4 rounded-lg"> <img src="/avatar.jpg" class="w-16 h-16 rounded-full mx-auto"> <p class="text-white text-center mt-2">ä½œè€…ï¼šmisakamayako</p>  <p class="text-white text-center mt-2">å‘å¸ƒæ—¶é—´ï¼š2024/08/26</p> </div> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">ç®€ä»‹</h3> <p class="text-white font-light mb-2">ä»‹ç»å¦‚ä½•ä½¿ç”¨Promiseã€ä»»åŠ¡é˜Ÿåˆ—ã€é”æœºåˆ¶å’Œæœ¬åœ°å­˜å‚¨ï¼ˆlocalforageï¼‰å®ç°æµè§ˆå™¨ç«¯é«˜æ•ˆå¼‚æ­¥æ•°æ®è·å–å’Œç®¡ç†ã€‚</p> </div> <!-- 2. æ–‡ç« ç›®å½• --> <!--<div class="bg-slate-700 p-4 rounded-lg">--> <!--    <h3 class="text-emerald-400 mb-2">æœ¬æ–‡ç›®å½•</h3>--> <!--    &lt;!&ndash;<TOC client:load /> &ndash;&gt;--> <!--</div>--> <!-- 3. çƒ­é—¨æ ‡ç­¾ --> <div class="bg-slate-700 p-4 rounded-lg"> <h3 class="text-emerald-400 mb-2">éšä¾¿çœ‹çœ‹</h3> <div class="flex flex-wrap gap-2"> <a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/undefined/"> é€šè¿‡ Kotlin åå°„è·å–å±æ€§æ³¨è§£å¹¶è¿›è¡Œæ ¡éªŒ </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/undefined/"> axiosåœ¨nodeç¯å¢ƒä¸­ä½¿ç”¨æ—¶ä¸èƒ½æ­£ç¡®è®¿é—®æœ¬åœ°æœåŠ¡çš„é—®é¢˜ </a><a class="px-3 py-1 bg-slate-600 rounded-full text-sm text-white hover:bg-emerald-500 transition" href="/blog/undefined/"> æµè§ˆå™¨ç«¯é€šè¿‡File Access APIéšè—ä¸‹è½½å®é™…é“¾æ¥çš„æ–¹æ³• </a> </div> </div> </div> </aside> <main class="grow h-full overflow-auto w-3/4 px-8"> <article class="text-white mb-2 prose lg:prose-xl prose-stone
                 prose-headings:text-white prose-strong:text-white prose-code:text-white
                 prose-a:text-violet-200 prose-blockquote:text-stone-100">  <header> <h1>æµè§ˆå™¨ç«¯å¼‚æ­¥æµæ•°æ®èµ„æºç®¡ç†</h1> </header> <h3 id="åŸºæœ¬æ€æƒ³">åŸºæœ¬æ€æƒ³</h3>
<ol>
<li>Promise å’Œå¼‚æ­¥æ“ä½œï¼š
<ul>
<li>Promiseå¯¹è±¡æ˜¯JavaScriptä¸­ç”¨æ¥å¤„ç†å¼‚æ­¥æ“ä½œçš„ä¸€ç§å°è£…æœºåˆ¶ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆæˆ–å¤±è´¥ï¼Œå¹¶ä¸”å¯ä»¥å°†å…¶ç»“æœä¼ é€’ç»™ç­‰å¾…çš„ä»£ç å—ã€‚</li>
<li>å¼‚æ­¥æ“ä½œç®¡ç†ï¼šé€šè¿‡Promiseå¯¹è±¡å¯ä»¥ä»¥æ›´åŠ æ¸…æ™°å’Œå¯ç»´æŠ¤çš„æ–¹å¼å¤„ç†å¼‚æ­¥æ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿå›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
</ul>
</li>
<li>ä»»åŠ¡é˜Ÿåˆ—å’Œé”æœºåˆ¶ï¼š
<ul>
<li>ä»»åŠ¡é˜Ÿåˆ—ç”¨äºå­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡å‡½æ•°ï¼Œç¡®ä¿å¼‚æ­¥ä»»åŠ¡æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œã€‚</li>
<li>é”æœºåˆ¶ç”¨æ¥é¿å…é‡å¤æ‰§è¡Œå’Œå¹¶å‘è®¿é—®é—®é¢˜ï¼Œä¾‹å¦‚åœ¨å¤šä¸ªåœ°æ–¹åŒæ—¶è¯·æ±‚åŒä¸€èµ„æºæ—¶ï¼Œé€šè¿‡é”æ¥æ§åˆ¶åªæœ‰ä¸€ä¸ªè¯·æ±‚å¯ä»¥è¿›è¡Œï¼Œé¿å…èµ„æºå†²çªå’Œæ•°æ®ä¸ä¸€è‡´æ€§ã€‚</li>
</ul>
</li>
</ol>
<h3 id="å®ç°">å®ç°</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> localforage </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "localforage"</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// ä½¿ç”¨localforageä½œä¸ºæœ¬åœ°å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒä½ å–œæ¬¢çš„æ¨¡å¼</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> DataSource</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">   // åŠ é”ï¼Œé˜²æ­¢ç”±äºå¤šå¤„è®¿é—®å¯¼è‡´å¹¶å‘é—®é¢˜ï¼Œå¦‚æœåœ¨workerä¸­ä½¿ç”¨ï¼Œé”éœ€è¦æ¢æˆAtomicsæ“ä½œæ”¯æŒçš„ç±»å‹</span></span>
<span class="line"><span style="color:#FFAB70">   #lock</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // åˆå§‹çŠ¶æ€ä¸‹æ´»è·ƒæ•°æ®æºä¸ºnullï¼Œå¹¶ä¸”è®¾ç½®ä¸ºç§æœ‰å±æ€§é˜²æ­¢å¤–éƒ¨ç›´æ¥è®¿é—®</span></span>
<span class="line"><span style="color:#FFAB70">   #activeDataStore</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // æ•°æ®åŠ è½½çŠ¶æ€</span></span>
<span class="line"><span style="color:#FFAB70">   #loaded</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // å­˜æ”¾ä»»åŠ¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#FFAB70">   #taskQueue</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // é€šè¿‡getter/setteræ§åˆ¶æ•°æ®è¯»å†™ï¼Œå¹¶ä¸”ä½¿ç”¨structuredCloneä½¿å„ä¸ªä½¿ç”¨çš„æ•°æ®ç›¸å¯¹ç‹¬ç«‹</span></span>
<span class="line"><span style="color:#F97583">   get</span><span style="color:#E1E4E8"> #</span><span style="color:#B392F0">dataSource</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#B392F0"> structuredClone</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#activeDataStore)</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">   set</span><span style="color:#E1E4E8"> #</span><span style="color:#B392F0">dataSource</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.#activeDataStore </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // å…¬å¼€çš„è·å–æ•°æ®æºæ–¹æ³•</span></span>
<span class="line"><span style="color:#F97583">   get</span><span style="color:#B392F0"> dataSource</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#loaded) {</span></span>
<span class="line"><span style="color:#6A737D">         // å¦‚æœæ•°æ®å·²ç»è·å–ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¹¶ä¸”ä¸ºäº†ç»“æ„ä¸€è‡´æ€§ï¼Œä»¥promiseå½¢å¼è¿”å›æ•°æ®</span></span>
<span class="line"><span style="color:#F97583">         return</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">resolve</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#dataSource)</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#6A737D">      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªpromiseå¹¶åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…</span></span>
<span class="line"><span style="color:#F97583">      let</span><span style="color:#E1E4E8"> res, rej</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> promise</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">resolve</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">reject</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> (res </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resolve, rej </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> reject))</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.#taskQueue.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({resolve: res, reject: rej})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // å¦‚æœå½“å‰å—å·²è¢«é”å®šï¼Œè¯´æ˜å·²æœ‰ä»»åŠ¡åœ¨æ‰§è¡Œä¸­ï¼Œè¿”å›promiseå¹¶ç­‰å¾…å³å¯</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#lock) {</span></span>
<span class="line"><span style="color:#F97583">         return</span><span style="color:#E1E4E8"> promise</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.#lock </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#tryLoadData</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> promise</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFAB70">   #retryCount</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">   #</span><span style="color:#B392F0">tryLoadData</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">         // å…ˆå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®</span></span>
<span class="line"><span style="color:#E1E4E8">         localforage.</span><span style="color:#B392F0">getItem</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"data"</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">localData</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (localData) {</span></span>
<span class="line"><span style="color:#79B8FF">               this</span><span style="color:#E1E4E8">.#dataSource </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> localData</span></span>
<span class="line"><span style="color:#79B8FF">               this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#success</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">            } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">               // å¦‚æœæœ¬åœ°å­˜å‚¨æ²¡æœ‰æ•°æ®ï¼Œä»APIè·å–æ•°æ®</span></span>
<span class="line"><span style="color:#B392F0">               someApi</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">remoteData</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                  localforage.</span><span style="color:#B392F0">setItem</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"data"</span><span style="color:#E1E4E8">, remoteData)</span></span>
<span class="line"><span style="color:#79B8FF">                  this</span><span style="color:#E1E4E8">.#dataSource </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> remoteData</span></span>
<span class="line"><span style="color:#79B8FF">                  this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#success</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">               }).</span><span style="color:#B392F0">catch</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">error</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">                  this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#retryOrHandleError</span><span style="color:#E1E4E8">(error)</span></span>
<span class="line"><span style="color:#E1E4E8">               })</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">         }).</span><span style="color:#B392F0">catch</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">e</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#retryOrHandleError</span><span style="color:#E1E4E8">(e)</span></span>
<span class="line"><span style="color:#E1E4E8">         })</span></span>
<span class="line"><span style="color:#E1E4E8">      } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e) {</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#retryOrHandleError</span><span style="color:#E1E4E8">(e)</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // æˆåŠŸåŠ è½½æ•°æ®åçš„å¤„ç†</span></span>
<span class="line"><span style="color:#E1E4E8">   #</span><span style="color:#B392F0">success</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      while</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#taskQueue.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.#taskQueue.</span><span style="color:#B392F0">shift</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">resolve</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#dataSource)</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#6A737D">      // é‡ç½®é”å®šçŠ¶æ€å’ŒåŠ è½½çŠ¶æ€</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.#lock </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.#loaded </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.#retryCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 5</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">   // å¤„ç†é”™è¯¯çš„é€»è¾‘</span></span>
<span class="line"><span style="color:#E1E4E8">   #</span><span style="color:#B392F0">retryOrHandleError</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#retryCount </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.#retryCount</span><span style="color:#F97583">--</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">#tryLoadData</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">         // å¦‚æœé‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œä¾æ¬¡å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè¿”å›é”™è¯¯</span></span>
<span class="line"><span style="color:#F97583">         while</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.#taskQueue.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.#taskQueue.</span><span style="color:#B392F0">shift</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">reject</span><span style="color:#E1E4E8">(error)</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#6A737D">         // é‡ç½®é”å®šçŠ¶æ€å’ŒåŠ è½½çŠ¶æ€</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.#lock </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.#loaded </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#79B8FF">         this</span><span style="color:#E1E4E8">.#retryCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 5</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// è®¾ç½®localforageçš„é©±åŠ¨ä¸ºINDEXEDDB</span></span>
<span class="line"><span style="color:#E1E4E8">localforage.</span><span style="color:#B392F0">setDriver</span><span style="color:#E1E4E8">(localforage.</span><span style="color:#79B8FF">INDEXEDDB</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ä½¿ç”¨å•ä¾‹æ¨¡å¼å¯¼å‡ºï¼Œä¿è¯æ•°æ®æºçš„å”¯ä¸€æ€§</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> DataSource</span><span style="color:#E1E4E8">()</span></span></code></pre>  </article> <div class="tags"> <div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/JavaScript">JavaScript</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/å¼‚æ­¥ç¼–ç¨‹">å¼‚æ­¥ç¼–ç¨‹</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/ä»»åŠ¡é˜Ÿåˆ—">ä»»åŠ¡é˜Ÿåˆ—</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/æœ¬åœ°å­˜å‚¨">æœ¬åœ°å­˜å‚¨</a> </div><div class="_tailmateTag_u5zwa_5"> <a href="/blog/tag/æ•°æ®ç®¡ç†">æ•°æ®ç®¡ç†</a> </div> </div> </main> </div> <div class="okTgGW_footer"> <p>Supported and developed by&nbsp;
<a href="https://github.com/misakamayako/" target="_blank" rel="noreferrer">misaka mayako</a> </p> <p>
Tech with <a href="https://astro.build/" target="_blank" rel="noreferrer">astro</a>,&nbsp;
<a href="https://tailwindcss.com/" target="_blank" rel="noreferrer">tailwindcss</a>,&nbsp;
        and <a href="https://pm2.keymetrics.io/" target="_blank" rel="noreferrer">pm2</a>,&nbsp;
</p> <p> feed back via <a href="mailto:misakamayaco@qq.com" target="_blank" rel="noreferrer">ğŸ“«</a></p> <a rel="license noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="absolute right-6 bottom-6"> <img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" class="inlin-block border-0" src="/cc4.0.png"> </a> </div> </div>  </body></html>